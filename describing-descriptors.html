<!DOCTYPE html>
<html lang="en-US">
    <head>
        <meta charset="utf-8"> 
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="author" content="Alec Nikolas Reiter" />
        <meta name="copyright" content="Alec Nikolas Reiter" />

        <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
        <link rel="stylesheet" href="/theme/slicknav.css">
        <script src="/theme/jquery.slicknav.min.js"></script>
        <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
        <script type="text/javascript"
            src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
        </script>
        <!--[if lt IE 9]>
        <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.6.2/html5shiv.js"></script>
        <![endif]-->


<meta name="keywords" content="python, descriptors, tutorials, " />
        <title>Describing Descriptors - from alec.thoughts import *
</title>
        <link href="http://cdn-images.mailchimp.com/embedcode/slim-081711.css" rel="stylesheet" type="text/css">
        <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/css/bootstrap-combined.min.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="http://justanr.github.io/theme/css/style.css" media="screen">
        <link rel="stylesheet" type="text/css" href="http://justanr.github.io/theme/css/solarizedlight.css" media="screen">
        <link rel="shortcut icon" href="http://justanr.github.io/theme/images/favicon.ico" type="image/x-icon" />
        <link rel="apple-touch-icon" href="http://justanr.github.io/theme/images/apple-touch-icon.png" />
        <link rel="apple-touch-icon" sizes="57x57" href="http://justanr.github.io/theme/images/apple-touch-icon-57x57.png" />
        <link rel="apple-touch-icon" sizes="72x72" href="http://justanr.github.io/theme/images/apple-touch-icon-72x72.png" />
        <link rel="apple-touch-icon" sizes="114x114" href="http://justanr.github.io/theme/images/apple-touch-icon-114x114.png" />
        <link rel="apple-touch-icon" sizes="144x144" href="http://justanr.github.io/theme/images/apple-touch-icon-144x144.png" />
        <link rel="icon" href="http://justanr.github.io/theme/images/apple-touch-icon-144x144.png" />
    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-64904436-1']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
    </head>
    <body>
        <div id="content-sans-footer">
        <div class="navbar navbar-static-top">
            <div class="navbar-inner">
                <div class="container">
                    <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </a>
                    <a class="brand" href="http://justanr.github.io/"><span class=site-name>from alec.thoughts import *</span></a>
                    <div class="nav-collapse collapse">
                        <ul class="nav pull-right top-menu">
                            <li ><a href="http://justanr.github.io">Home</a></li>
                            <li ><a href="http://justanr.github.io/categories.html">Categories</a></li>
                            <li ><a href="http://justanr.github.io/tags.html">Tags</a></li>
                            <li ><a href="http://justanr.github.io/archives.html">Archives</a></li>
                            <li><form class="navbar-search" action="http://justanr.github.io/search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="container-fluid">
            <div class="row-fluid">
                <div class="span1"></div>
                <div class="span10">
<article>
<div class="row-fluid">
    <header class="page_header span10 offset2">
    <h1><a href="http://justanr.github.io/describing-descriptors"> Describing Descriptors  </a></h1>
    </header>
</div>

<div class="row-fluid">
        <div class="span8 offset2 article-content">

            <p><strong>An Aside:</strong> Just like my post on decorators, I've decided to rewrite
this post as well because it suffered from the same issue: &quot;Look at all
this code...and hey, there's explainations as well.&quot; Instead of
exploring patterns, like I did in the decorator post, I'm going to focus
in on one example use that explores several aspects of descriptors all
at once. Of course, I'll step through it piece by piece. There's
actually going to be two major sections to this post:</p>
<ul class="simple">
<li>Python Object Attribute Access</li>
<li>Writing Our First Descriptor</li>
</ul>
<p>Also, this post was built with Python 3.4 in mind. While it's foolish to
think that everyone everywhere is using the latest and greatest Python
release, it's what I've been using primarily lately. That's me.</p>
<p><strong>Updated</strong> Nov. 8th, 2014: Added concrete examples of behind the scenes
action of descriptors as well as a brief explaination of what
<tt class="docutils literal">__delete__</tt> does.</p>
<div class="section" id="controlling-attribute-access">
<h2>Controlling Attribute Access</h2>
<p>Before digging into descriptors, it's important to talk about attribute
access. Because at the end of the day, that's what descriptors do for
us. There's really two ways of going about this with explicitly building
our own descriptor.</p>
<div class="section" id="getters-and-setters">
<h3>Getters and Setters</h3>
<p>This is what you'll see in many languages: explicit getters and setters.
They're methods that handle attributes for us. This is very common in
Java and PHP (or at least as of the last time I seriously used PHP).
Essentially, the idea is to <em>always</em> expect to interact with a method
instead of an attribute itself. There's nothing wrong with this if it's
what your language of choice supports and you need to control access.</p>
<pre class="code ipython3 literal-block">
<span class="c1"># it's a contrived example</span>
<span class="c1"># but bear with me here</span>
<span class="c1"># pretend this is *important business logic*</span>
<span class="k">def</span> <span class="nf">to_lower</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">Person</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__name</span>

    <span class="k">def</span> <span class="nf">set_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__name</span> <span class="o">=</span> <span class="n">to_lower</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

<span class="n">monty</span> <span class="o">=</span> <span class="n">Person</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;John Cleese&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">monty</span><span class="o">.</span><span class="n">get_name</span><span class="p">())</span>
<span class="n">monty</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="s2">&quot;Eric Idle&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">monty</span><span class="o">.</span><span class="n">get_name</span><span class="p">())</span>
</pre>
<pre class="literal-block">
john cleese
eric idle
</pre>
<p>That's fine and dandy. <em>If</em> that's what you language supports. Python,
in my opinion, handles this better.</p>
</div>
<div class="section" id="property">
<h3>&#64;property</h3>
<p>The real way you'd write this in Python is by using <tt class="docutils literal">&#64;property</tt>. Which
is a decorator, which we are familiar with. I won't go into details
about what's going on behind the scenes yet.</p>
<pre class="code ipython3 literal-block">
<span class="k">class</span> <span class="nc">Person</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

    <span class="nd">&#64;property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__name</span>

    <span class="nd">&#64;name</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__name</span> <span class="o">=</span> <span class="n">to_lower</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

<span class="n">monty</span> <span class="o">=</span> <span class="n">Person</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Graham Chapman&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">monty</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="n">monty</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Terry Gilliam&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="n">monty</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</pre>
<pre class="literal-block">
graham chapman
terry gilliam
</pre>
<p>For now, don't worry that I have <em>two</em> methods called <tt class="docutils literal">name</tt>. It'll
become apparent in a little bit.</p>
<p>That is a much cleaner interface to the class. As far as the calling
code is concerned, <tt class="docutils literal">name</tt> is just another attribute. This is fantastic
if you designed an object and later realized that you need to control
how an attribute is returned or set (or deleted, but I'm not going to
delve into that aspect of descriptors at all in this post).</p>
<p>To many people, this is where they'd stop with controlling attribute
access. And frankly, I don't really blame them. <tt class="docutils literal">&#64;property</tt> seems to
be magic enough behind the scenes already. Why is it disappearing into
<tt class="docutils literal">name</tt>, where does <tt class="docutils literal">setter</tt> come from, how does it work? These are
questions that might go unasked or, worse: unanswered.</p>
<p><tt class="docutils literal">&#64;property</tt> suffices in <em>most</em> situations, especially when you only
need to control one attribute in a specific way. But imagine if we had
to ensure two or three attributes were all lower case? You might be
tempted to replicate the code all the way down. You don't mind a little
repitition, do you?</p>
<pre class="code ipython3 literal-block">
<span class="k">class</span> <span class="nc">Person</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">firstname</span><span class="p">,</span> <span class="n">lastname</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__f_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__l_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__email</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f_name</span> <span class="o">=</span> <span class="n">firstname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l_name</span> <span class="o">=</span> <span class="n">lastname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span>

    <span class="nd">&#64;property</span>
    <span class="k">def</span> <span class="nf">f_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__f_name</span>

    <span class="nd">&#64;f_name</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">f_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__f_name</span> <span class="o">=</span> <span class="n">to_lower</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="nd">&#64;property</span>
    <span class="k">def</span> <span class="nf">l_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__l_name</span>

    <span class="nd">&#64;l_name</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">l_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__l_name</span> <span class="o">=</span> <span class="n">to_lower</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="nd">&#64;property</span>
    <span class="k">def</span> <span class="nf">email</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__email</span>

    <span class="nd">&#64;email</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">email</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__email</span> <span class="o">=</span> <span class="n">to_lower</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

<span class="n">monty</span> <span class="o">=</span> <span class="n">Person</span><span class="p">(</span><span class="n">firstname</span><span class="o">=</span><span class="s1">'Michael'</span><span class="p">,</span> <span class="n">lastname</span><span class="o">=</span><span class="s1">'Palin'</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s1">'MichaelPalin&#64;montypython.com'</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">monty</span><span class="o">.</span><span class="n">f_name</span><span class="p">,</span> <span class="n">monty</span><span class="o">.</span><span class="n">l_name</span><span class="p">,</span> <span class="n">monty</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
</pre>
<pre class="literal-block">
michael palin <a class="reference external" href="mailto:michaelpalin&#64;montypython.com">michaelpalin&#64;montypython.com</a>
</pre>
<p>Like I said, it's a contrived example. But instead of ensuring things
are lower cased, imagine you're attempting to keep text fields in a GUI
synchronized with the state of an object or you're working with a
database ORM. Things will very quickly get out of hand if you have to
property a <em>ton</em> of stuff with the logic repeated except for the names.</p>
<div class="section" id="behind-the-scenes">
<h4>Behind the Scenes</h4>
<p>I'm not going to 100% faithfully recreate <tt class="docutils literal">&#64;property</tt> here, frankly I
don't see a point. But I do want to dissect it from what we can observe
on the surface.</p>
<ul class="simple">
<li><tt class="docutils literal">property</tt> is a decorator. As a decorator it's a function that
takes a function and returns a callable. This we know.</li>
<li>The callable created by <tt class="docutils literal">property</tt> is an object</li>
<li>The object has at least one method on it, <tt class="docutils literal">setter</tt>, that somehow
controls <em>how</em> a variable is set</li>
</ul>
<p>However, if we inspect <tt class="docutils literal">property</tt> (my preferred way is with IPython's
<tt class="docutils literal">?</tt> and <tt class="docutils literal"><span class="pre">??</span></tt> magics) we learn that there is one more method and
three attributes that aren't immediately obvious to us.</p>
<ul class="simple">
<li><tt class="docutils literal">deleter</tt> is the missing method, which handles how an attribute is
deleted with <tt class="docutils literal">del</tt></li>
<li><tt class="docutils literal">fget</tt>, <tt class="docutils literal">fset</tt> and <tt class="docutils literal">fdel</tt> are the attributes, which are
unsurprisingly the original functions for getting, setting and
deleting attributes.</li>
</ul>
<p>For the above example, <tt class="docutils literal">fget</tt> and <tt class="docutils literal">fset</tt> are our two <tt class="docutils literal">name</tt>
methods above. They actually get hidden away into an object decorator,
which is how we have two methods with the same name without worry.</p>
</div>
</div>
</div>
<div class="section" id="data-model">
<h2>Data model</h2>
<p>This about as far as we can get without understanding how Python
accesses attributes on objects. I won't attempt to give a complete in
depth analysis of <em>how</em> Python actually accesses and sets attributes on
objects, but this is a simplified, high level view of what's going on
(ignoring the existence of <tt class="docutils literal">__slots__</tt>, which actually replaces the
underlying <tt class="docutils literal">__dict__</tt> with a set of descriptors and what's going on
there I'm not 100% sure of).</p>
<ol class="arabic simple">
<li>Call <tt class="docutils literal">__getattribute__</tt></li>
<li>Look up in the object's dictionary</li>
<li>Look up in the class's dictionary</li>
<li>Walk the MRO and look up in those dictionaries</li>
<li>If present and all other look ups have failed, call <tt class="docutils literal">__getattr__</tt></li>
<li>If the name resolves to a descriptor, return the value of it's
<tt class="docutils literal">__get__</tt> method</li>
<li>If all all else fails, raise an <tt class="docutils literal">AttributeError</tt></li>
</ol>
<p>That sixth point is the most pertinent to us. An object that defines a
<tt class="docutils literal">__get__</tt> method is known as a descriptor. <tt class="docutils literal">property</tt> is actually an
object that does this. In effect, it's <tt class="docutils literal">__get__</tt> method resembles
this:</p>
<pre class="code ipython3 literal-block">
<span class="k">def</span> <span class="nf">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fget</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</pre>
<p>Similarly, the resolution for setting an attribute looks like this:</p>
<ol class="arabic simple">
<li>If present, call <tt class="docutils literal">__setattr__</tt></li>
<li>If the name resolves to a descriptor, call it's <tt class="docutils literal">__set__</tt> method</li>
<li>Stuff the value into the object's dict</li>
</ol>
<p>So, property's <tt class="docutils literal">__set__</tt> looks like this:</p>
<pre class="code ipython3 literal-block">
<span class="k">def</span> <span class="nf">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fset</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</pre>
<p>I'm glossing over raising attribute errors for attributes that don't
support reading or writing, but <tt class="docutils literal">property</tt> does that. There's two
reasons I'm positive this is how these two methods look is because I'm
familar with the descriptor protocol and Raymond Hettinger wrote about
it
<a class="reference external" href="https://docs.python.org/3/howto/descriptor.html#properties">here</a>.</p>
<div class="section" id="descriptor-protocol">
<h3>Descriptor Protocol</h3>
<p>There's three parts to the descriptor protocol: <tt class="docutils literal">__get__</tt>, <tt class="docutils literal">__set__</tt>
and <tt class="docutils literal">__delete__</tt>. Like I said, I'm not delving into deleting
attributes here, so we'll remain unconcerned with that. But any object
that defines at least one of these methods is a descriptor.</p>
<p>The best way to dissect a descriptor is provide an example
implementation. This example isn't actually going to do anything except
emulate regular attribute access.</p>
<pre class="code ipython3 literal-block">
<span class="k">class</span> <span class="nc">Descriptor</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

    <span class="k">def</span> <span class="nf">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">instance</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">instance</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">__delete__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">):</span>
        <span class="k">del</span> <span class="n">instance</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">Thing</span><span class="p">:</span>
    <span class="n">frob</span> <span class="o">=</span> <span class="n">Descriptor</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">'frob'</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frob</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frob</span> <span class="o">=</span> <span class="n">frob</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">Thing</span><span class="p">(</span><span class="n">frob</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">frob</span><span class="p">)</span>
</pre>
<pre class="literal-block">
4
</pre>
<div class="section" id="get">
<h4><tt class="docutils literal">__get__</tt></h4>
<pre class="literal-block">
def __get__(self, instance, type):
</pre>
<ul class="simple">
<li><tt class="docutils literal">self</tt> is the instance of the descriptor itself, just like any
other object.</li>
<li><tt class="docutils literal">instance</tt> is an instance of the class it's attached to</li>
<li><tt class="docutils literal">type</tt> is the actual object that it's attached to, I typically
prefer to use <tt class="docutils literal">cls</tt> as the name here because it's slightly more
clear to me. <tt class="docutils literal">owner</tt> is another common name, but slightly more
confusing to me.</li>
</ul>
<p>Above, when we request <tt class="docutils literal">t.frob</tt> what's actually happening behind the
scenes is Python is calling <tt class="docutils literal">Thing.frob.__get__(t, Thing)</tt> instead of
passing <tt class="docutils literal">Thing.frob.__get__</tt> directly to the print function. The
reason the actual class is passed as well is &quot;to give you information
about what object the descriptor is part of&quot;, to quote <a class="reference external" href="http://nbviewer.ipython.org/gist/ChrisBeaumont/5758381/descriptor_writeup.ipynb">Chris
Beaumont</a>.
While I've not made use of inspecting which class the descriptor is part
of, this could be valuable information.</p>
<p>You could also call <tt class="docutils literal">Thing.frob.__get__(t, Thing)</tt> explicitly if you'd
like, but Python's data model will handle this for us.</p>
</div>
<div class="section" id="set">
<h4><tt class="docutils literal">__set__</tt></h4>
<pre class="literal-block">
def __set__(self, instance, value):
</pre>
<ul class="simple">
<li><tt class="docutils literal">self</tt> again no surprises here, this is the instance of the
descriptor</li>
<li><tt class="docutils literal">instance</tt> this is an instance of the class it's attached to</li>
<li><tt class="docutils literal">value</tt> is the value you're passing in, if you've used <tt class="docutils literal">property</tt>
before, there's no surprise here.</li>
</ul>
<p>Again, what's happening behind the scenes when we set <tt class="docutils literal">t.frob</tt> to
something (in this case, just in <tt class="docutils literal">Thing.__init__</tt>), Python passes
information to <tt class="docutils literal">Thing.frob.__set__</tt>, the information just being the
instance of <tt class="docutils literal">Thing</tt> and the value we're setting.</p>
</div>
<div class="section" id="delete">
<h4><tt class="docutils literal">__delete__</tt></h4>
<pre class="literal-block">
def __delete__(self, instance):
</pre>
<p>No surprises here. And despite that I said I wasn't going to go into
deleting attributes with descriptors, I've included it for completion's
sake. The delete method handles what happens when we call
<tt class="docutils literal">del t.frob</tt>.</p>
</div>
<div class="section" id="data-vs-non-data-descriptor">
<h4>Data vs Non-Data Descriptor</h4>
<p>This is something you're going to encounter when reading about and
working with descriptors: the difference between a data and non-data
descriptor and how Python treats both when looking up an attribute.</p>
<div class="section" id="data-descriptor">
<h5>Data Descriptor</h5>
<p>A data descriptor is a descriptor that defines <em>both</em> a <tt class="docutils literal">__get__</tt> and
<tt class="docutils literal">__set__</tt> method. These descriptors recieve <em>higher</em> priority if
Python finds a descriptor and a <tt class="docutils literal">__dict__</tt> entry for the attribute
being looked up. Already, you can see that attribute access isn't as
clear cut as we thought it was.</p>
</div>
<div class="section" id="non-data-descriptor">
<h5>Non-Data Descriptor</h5>
<p>A non-data descriptor is a descriptor that defines <em>only</em> a <tt class="docutils literal">__get__</tt>
method. These descriptors recieve a <em>lower</em> priority if Python finds
both the descriptor and a <tt class="docutils literal">__dict__</tt> entry.</p>
</div>
</div>
</div>
</div>
<div class="section" id="what-does-this-mean">
<h2>What does this mean?</h2>
<p>By using descriptors we can create <a class="reference external" href="http://nbviewer.ipython.org/gist/ChrisBeaumont/5758381/descriptor_writeup.ipynb">reusable
properties</a>,
as Chris Beaumont calls them and I find to be an incredibly apt
definition. But there's quite a few pits we can fall into. For the rest
of this post, I'm going to focus on rebuilding our lower case properties
as a reusable descriptor. In another post, I'm going to more fully
explore some of the power these put at our finger tips.</p>
</div>
<div class="section" id="our-first-descriptor">
<h2>Our First Descriptor</h2>
<p>So far, we know a descriptor needs to define <em>at least</em> one of
<tt class="docutils literal">__get__</tt>, <tt class="docutils literal">__set__</tt>, or <tt class="docutils literal">__delete__</tt>. Let's try our hand at
building a <tt class="docutils literal">LowerString</tt> descriptor.</p>
<pre class="code ipython3 literal-block">
<span class="k">class</span> <span class="nc">LowerString</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>

    <span class="k">def</span> <span class="nf">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">to_lower</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Person</span><span class="p">:</span>
    <span class="n">f_name</span> <span class="o">=</span> <span class="n">LowerString</span><span class="p">()</span>
    <span class="n">l_name</span> <span class="o">=</span> <span class="n">LowerString</span><span class="p">()</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">LowerString</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">firstname</span><span class="p">,</span> <span class="n">lastname</span><span class="p">,</span> <span class="n">email</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f_name</span> <span class="o">=</span> <span class="n">firstname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l_name</span> <span class="o">=</span> <span class="n">lastname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span>

<span class="n">monty</span> <span class="o">=</span> <span class="n">Person</span><span class="p">(</span><span class="n">firstname</span><span class="o">=</span><span class="s2">&quot;Terry&quot;</span><span class="p">,</span> <span class="n">lastname</span><span class="o">=</span><span class="s2">&quot;Jones&quot;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;TerryJONES&#64;montyPython.com&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">monty</span><span class="o">.</span><span class="n">f_name</span><span class="p">,</span> <span class="n">monty</span><span class="o">.</span><span class="n">l_name</span><span class="p">,</span> <span class="n">monty</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
</pre>
<pre class="literal-block">
terry jones <a class="reference external" href="mailto:terryjones&#64;montypython.com">terryjones&#64;montypython.com</a>
</pre>
<p>While this isn't as perfectly clean as we might like, it's certainly a
lot prettier than using a series of <tt class="docutils literal">property</tt> decorators and way
nicer than defining explicit getters and setters. However, there's a big
issue here. If you can't spot it, I'll point it out.</p>
<pre class="code ipython3 literal-block">
<span class="n">me</span> <span class="o">=</span> <span class="n">Person</span><span class="p">(</span><span class="n">firstname</span><span class="o">=</span><span class="s2">&quot;Alec&quot;</span><span class="p">,</span> <span class="n">lastname</span><span class="o">=</span><span class="s2">&quot;Reiter&quot;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;alecreiter&#64;fake.com&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">me</span><span class="o">.</span><span class="n">f_name</span><span class="p">,</span> <span class="n">me</span><span class="o">.</span><span class="n">l_name</span><span class="p">,</span> <span class="n">me</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">monty</span><span class="o">.</span><span class="n">f_name</span><span class="p">,</span> <span class="n">monty</span><span class="o">.</span><span class="n">l_name</span><span class="p">,</span> <span class="n">monty</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
</pre>
<pre class="literal-block">
alec reiter <a class="reference external" href="mailto:alecreiter&#64;fake.com">alecreiter&#64;fake.com</a>
alec reiter <a class="reference external" href="mailto:alecreiter&#64;fake.com">alecreiter&#64;fake.com</a>
</pre>
<p>...oh. Well that happened. And the reason for this, and this what
tripped me up when I began reading about descriptors, is that each
instance of person <em>shares</em> the same instances of <tt class="docutils literal">LowerString</tt> for
the three properties. Descriptors enforce a shared state by virture of
being <em>instances</em> attached to a <em>class</em> rather than <em>instances</em>. So
instead of composing an instance of an object with other objects (say a
Person object composed of <tt class="docutils literal">Job</tt>, <tt class="docutils literal">Nationality</tt> and <tt class="docutils literal">Gender</tt>
instances), we compose a class out of object instances.</p>
<p>If we examine the <tt class="docutils literal">__dict__</tt> for both the class and the instance, it
becomes apparent where Python finds these values at:</p>
<pre class="code ipython3 literal-block">
<span class="nb">print</span><span class="p">(</span><span class="n">Person</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">monty</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
</pre>
<pre class="literal-block">
{'__doc__': None, '__weakref__': &lt;attribute '__weakref__' of 'Person' objects&gt;, '__init__': &lt;function Person.__init__ at 0x7f337e2e58c8&gt;, 'f_name': &lt;__main__.LowerString object at 0x7f337ce4a5c0&gt;, 'l_name': &lt;__main__.LowerString object at 0x7f337ce4a550&gt;, 'email': &lt;__main__.LowerString object at 0x7f337ce4a630&gt;, '__module__': '__main__', '__dict__': &lt;attribute '__dict__' of 'Person' objects&gt;}
{}
</pre>
<p>Since the descriptors aren't attached at the instance level, Python
moves up to the class level where it finds the attribute we're
requesting, sees it's a descriptor and then calls the <tt class="docutils literal">__get__</tt>
method.</p>
<p>If you attempt to attach these descriptors at the instance level
instead, you end up with this:</p>
<pre class="code ipython3 literal-block">
<span class="k">class</span> <span class="nc">Person</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">firstname</span><span class="p">,</span> <span class="n">lastname</span><span class="p">,</span> <span class="n">email</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f_name</span> <span class="o">=</span> <span class="n">LowerString</span><span class="p">(</span><span class="n">firstname</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l_name</span> <span class="o">=</span> <span class="n">LowerString</span><span class="p">(</span><span class="n">lastname</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">LowerString</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>

<span class="n">me</span> <span class="o">=</span> <span class="n">Person</span><span class="p">(</span><span class="n">firstname</span><span class="o">=</span><span class="s2">&quot;Alec&quot;</span><span class="p">,</span> <span class="n">lastname</span><span class="o">=</span><span class="s2">&quot;Reiter&quot;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;alecreiter&#64;fake.com&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">me</span><span class="o">.</span><span class="n">f_name</span><span class="p">,</span> <span class="n">me</span><span class="o">.</span><span class="n">l_name</span><span class="p">,</span> <span class="n">me</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
</pre>
<pre class="literal-block">
&lt;__main__.LowerString object at 0x7f337ce4e390&gt; &lt;__main__.LowerString object at 0x7f337ce4e400&gt; &lt;__main__.LowerString object at 0x7f337ce4e438&gt;
</pre>
<p>So explicitly attaching them to the instances won't work. But remember,
Python passes the instance <em>for us</em> automatically. Let's try storing the
value on the underlying object by accessing it's <tt class="docutils literal">__dict__</tt> attribute:</p>
<pre class="code ipython3 literal-block">
<span class="k">class</span> <span class="nc">LowerString</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">label</span>

    <span class="k">def</span> <span class="nf">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">instance</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">instance</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">to_lower</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Person</span><span class="p">:</span>
    <span class="n">f_name</span> <span class="o">=</span> <span class="n">LowerString</span><span class="p">(</span><span class="s1">'f_name'</span><span class="p">)</span>
    <span class="n">l_name</span> <span class="o">=</span> <span class="n">LowerString</span><span class="p">(</span><span class="s1">'l_name'</span><span class="p">)</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">LowerString</span><span class="p">(</span><span class="s1">'email'</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">firstname</span><span class="p">,</span> <span class="n">lastname</span><span class="p">,</span> <span class="n">email</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f_name</span> <span class="o">=</span> <span class="n">firstname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l_name</span> <span class="o">=</span> <span class="n">lastname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span>

<span class="n">monty</span> <span class="o">=</span> <span class="n">Person</span><span class="p">(</span><span class="n">firstname</span><span class="o">=</span><span class="s2">&quot;Carol&quot;</span><span class="p">,</span> <span class="n">lastname</span><span class="o">=</span><span class="s2">&quot;Cleaveland&quot;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;seventh&#64;montypython.com&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">monty</span><span class="o">.</span><span class="n">f_name</span><span class="p">,</span> <span class="n">monty</span><span class="o">.</span><span class="n">l_name</span><span class="p">,</span> <span class="n">monty</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
</pre>
<pre class="literal-block">
carol cleaveland <a class="reference external" href="mailto:seventh&#64;montypython.com">seventh&#64;montypython.com</a>
</pre>
<p>And surely this works, but we've run into the issue of repeating
ourselves again. It'd be nice if we could simply do something to
automatically fill in the label for us. David Beazley addressed this
problem in the <a class="reference external" href="http://www.amazon.com/Python-Cookbook-David-Beazley/dp/1449340377">3rd Edition of the Python
Cookbook</a>.</p>
<pre class="code ipython3 literal-block">
<span class="k">class</span> <span class="nc">checkedmeta</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">clsname</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">methods</span><span class="p">):</span>
        <span class="c1"># Attach attribute names to the descriptors</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">methods</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Descriptor</span><span class="p">):</span>
                <span class="n">value</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">key</span>
        <span class="k">return</span> <span class="nb">type</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">clsname</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">methods</span><span class="p">)</span>
</pre>
<p>Of course this means, we need to make two small changes to our
descriptor: changing <tt class="docutils literal">label</tt> to <tt class="docutils literal">name</tt> and inheriting from a base
<tt class="docutils literal">Descriptor</tt> class.</p>
<pre class="code ipython3 literal-block">
<span class="k">class</span> <span class="nc">Descriptor</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

<span class="k">class</span> <span class="nc">LowerString</span><span class="p">(</span><span class="n">Descriptor</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">instance</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">instance</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">to_lower</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Person</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">checkedmeta</span><span class="p">):</span>
    <span class="n">f_name</span> <span class="o">=</span> <span class="n">LowerString</span><span class="p">()</span>
    <span class="n">l_name</span> <span class="o">=</span> <span class="n">LowerString</span><span class="p">()</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">LowerString</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">firstname</span><span class="p">,</span> <span class="n">lastname</span><span class="p">,</span> <span class="n">email</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f_name</span> <span class="o">=</span> <span class="n">firstname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l_name</span> <span class="o">=</span> <span class="n">lastname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span>

<span class="n">monty</span> <span class="o">=</span> <span class="n">Person</span><span class="p">(</span><span class="n">firstname</span><span class="o">=</span><span class="s2">&quot;Carol&quot;</span><span class="p">,</span> <span class="n">lastname</span><span class="o">=</span><span class="s2">&quot;Cleaveland&quot;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;seventh&#64;montypython.com&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">monty</span><span class="o">.</span><span class="n">f_name</span><span class="p">,</span> <span class="n">monty</span><span class="o">.</span><span class="n">l_name</span><span class="p">,</span> <span class="n">monty</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
</pre>
<pre class="literal-block">
carol cleaveland <a class="reference external" href="mailto:seventh&#64;montypython.com">seventh&#64;montypython.com</a>
</pre>
<p>And this is very nice and handy. If later, we wanted to create an
<tt class="docutils literal">EmailValidator</tt> descriptor, so long as we adhere to the pattern laid
out here, we can attach them to any class that uses the <tt class="docutils literal">checkedmeta</tt>
metaclass and it'll behave as expected.</p>
<p>But there's something still very annoying going on and it's one of the
biggest gripes with <tt class="docutils literal">property</tt> is that a <tt class="docutils literal">getter</tt> has to be defined
<em>even if I'm only interested in the setter</em>. If you set <tt class="docutils literal">fget</tt> to
None, you end up getting an attribute error that says it's write only.
If we examine our current implementation, we'll notice something else as
well:</p>
<pre class="code ipython3 literal-block">
<span class="nb">print</span><span class="p">(</span><span class="n">Person</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">monty</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
</pre>
<pre class="literal-block">
{'__doc__': None, '__weakref__': &lt;attribute '__weakref__' of 'Person' objects&gt;, '__init__': &lt;function Person.__init__ at 0x7f337ce38c80&gt;, 'f_name': &lt;__main__.LowerString object at 0x7f337ce31588&gt;, 'l_name': &lt;__main__.LowerString object at 0x7f337ce31550&gt;, 'email': &lt;__main__.LowerString object at 0x7f337ce316a0&gt;, '__module__': '__main__', '__dict__': &lt;attribute '__dict__' of 'Person' objects&gt;}
{'email': <a class="reference external" href="mailto:'seventh&#64;montypython.com">'seventh&#64;montypython.com</a>', 'f_name': 'carol', 'l_name': 'cleaveland'}
</pre>
<p>There's now the descriptors living at the class level and the values
living at the instance level. Let's add some &quot;debugging&quot; print calls to
see what's happening on the inside.</p>
<pre class="code ipython3 literal-block">
<span class="k">class</span> <span class="nc">LowerString</span><span class="p">(</span><span class="n">Descriptor</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

    <span class="k">def</span> <span class="nf">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Calling LowerString.__get__&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">instance</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Calling LowerString.__set__&quot;</span><span class="p">)</span>
        <span class="n">instance</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">to_lower</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Person</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">checkedmeta</span><span class="p">):</span>
    <span class="n">f_name</span> <span class="o">=</span> <span class="n">LowerString</span><span class="p">()</span>
    <span class="n">l_name</span> <span class="o">=</span> <span class="n">LowerString</span><span class="p">()</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">LowerString</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">firstname</span><span class="p">,</span> <span class="n">lastname</span><span class="p">,</span> <span class="n">email</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f_name</span> <span class="o">=</span> <span class="n">firstname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l_name</span> <span class="o">=</span> <span class="n">lastname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span>

<span class="n">monty</span> <span class="o">=</span> <span class="n">Person</span><span class="p">(</span><span class="n">firstname</span><span class="o">=</span><span class="s2">&quot;Carol&quot;</span><span class="p">,</span> <span class="n">lastname</span><span class="o">=</span><span class="s2">&quot;Cleaveland&quot;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;seventh&#64;montypython.com&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">monty</span><span class="o">.</span><span class="n">f_name</span><span class="p">,</span> <span class="n">monty</span><span class="o">.</span><span class="n">l_name</span><span class="p">,</span> <span class="n">monty</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
</pre>
<pre class="literal-block">
Calling LowerString.__set__
Calling LowerString.__set__
Calling LowerString.__set__
Calling LowerString.__get__
Calling LowerString.__get__
Calling LowerString.__get__
carol cleaveland <a class="reference external" href="mailto:seventh&#64;montypython.com">seventh&#64;montypython.com</a>
</pre>
<p>Python gives special preference to data descriptors (as described
before). However, we can remove this special preference by simply
removing the <tt class="docutils literal">__get__</tt> method. Arguably, this is the most useless part
of this descriptor anyways, it's not transforming the result or
providing a lazy calculation, it's simply aping what
<tt class="docutils literal">Person.__getattribute__</tt> would do in the first place: Find the value
in the object's dictionary. If we remove this, then we're left with
<em>only</em> a setter, which is what we really wanted in the first place:</p>
<pre class="code ipython3 literal-block">
<span class="k">class</span> <span class="nc">LowerString</span><span class="p">(</span><span class="n">Descriptor</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

    <span class="k">def</span> <span class="nf">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Calling LowerString.__set__&quot;</span><span class="p">)</span>
        <span class="n">instance</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">to_lower</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Person</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">checkedmeta</span><span class="p">):</span>
    <span class="n">f_name</span> <span class="o">=</span> <span class="n">LowerString</span><span class="p">()</span>
    <span class="n">l_name</span> <span class="o">=</span> <span class="n">LowerString</span><span class="p">()</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">LowerString</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">firstname</span><span class="p">,</span> <span class="n">lastname</span><span class="p">,</span> <span class="n">email</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f_name</span> <span class="o">=</span> <span class="n">firstname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l_name</span> <span class="o">=</span> <span class="n">lastname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span>

<span class="n">monty</span> <span class="o">=</span> <span class="n">Person</span><span class="p">(</span><span class="n">firstname</span><span class="o">=</span><span class="s2">&quot;Carol&quot;</span><span class="p">,</span> <span class="n">lastname</span><span class="o">=</span><span class="s2">&quot;Cleaveland&quot;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;seventh&#64;montypython.com&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">monty</span><span class="o">.</span><span class="n">f_name</span><span class="p">,</span> <span class="n">monty</span><span class="o">.</span><span class="n">l_name</span><span class="p">,</span> <span class="n">monty</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
<span class="n">monty</span><span class="o">.</span><span class="n">f_name</span> <span class="o">=</span> <span class="s2">&quot;Cheryl&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="n">monty</span><span class="o">.</span><span class="n">f_name</span><span class="p">)</span>
</pre>
<pre class="literal-block">
Calling LowerString.__set__
Calling LowerString.__set__
Calling LowerString.__set__
carol cleaveland <a class="reference external" href="mailto:seventh&#64;montypython.com">seventh&#64;montypython.com</a>
Calling LowerString.__set__
cheryl
</pre>
<p>And this has to do with how Python sets attributes, which examined
above. Again, it's giving special precedence to the descriptor, which is
what we want in the first place. However, when we access the attribute,
it sees there's an entry in the object's <tt class="docutils literal">__dict__</tt> and the class's
<tt class="docutils literal">__dict__</tt> but the latter doesn't have a <tt class="docutils literal">__get__</tt> method, which
causes it to default back to the object's entry.</p>
<pre class="code ipython3 literal-block">
<span class="nb">print</span><span class="p">(</span><span class="n">Person</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">monty</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
</pre>
<pre class="literal-block">
{'__doc__': None, '__weakref__': &lt;attribute '__weakref__' of 'Person' objects&gt;, '__init__': &lt;function Person.__init__ at 0x7f337ce43730&gt;, 'f_name': &lt;__main__.LowerString object at 0x7f337ce55710&gt;, 'l_name': &lt;__main__.LowerString object at 0x7f337ce55748&gt;, 'email': &lt;__main__.LowerString object at 0x7f337ce55780&gt;, '__module__': '__main__', '__dict__': &lt;attribute '__dict__' of 'Person' objects&gt;}
{'email': <a class="reference external" href="mailto:'seventh&#64;montypython.com">'seventh&#64;montypython.com</a>', 'f_name': 'cheryl', 'l_name': 'cleaveland'}
</pre>
<p>Leaving us with just the setter and no unnecessary data or method
duplication.</p>
</div>
<div class="section" id="going-forward">
<h2>Going forward</h2>
<p>In the original post, I also explored building an oberserver pattern
with descriptors, something Chris Beaumont also touches upon briefly but
leaves a lot on the table as far registering callbacks on every instance
and specific instances of classes. I plan on touching on this again in a
future post.</p>
<p>But for now, I'm hoping this leaves a much better impression of
descriptors than my original post. Again, this isn't meant to be a tell
all about descriptors but hopefully serves to clarify a lot of the magic
that appears to happen behind the scenes when you're using SQLAlchemy
and defining models.</p>
<div class="section" id="further-learning">
<h3>Further Learning</h3>
<ul class="simple">
<li><a class="reference external" href="http://nbviewer.ipython.org/gist/ChrisBeaumont/5758381/descriptor_writeup.ipynb">Chris Beaumont's Python Descriptors
Demystified</a></li>
<li><a class="reference external" href="http://pyvideo.org/video/1716/python-3-metaprogramming">David Beazley's Python 3
Metaprograming</a>
this presentation explores <em>far</em> more than just descriptors and
delves into a lot of advanced concepts</li>
<li><a class="reference external" href="http://pyvideo.org/video/1760/encapsulation-with-descriptors">Luciano Ramalho's Encapsulation with
Descriptors</a></li>
<li><a class="reference external" href="https://docs.python.org/3/howto/descriptor.html">Python.org Descriptor How To by Raymond
Hettinger</a></li>
<li>And whole host of SO Questions, just to show a few:<ul>
<li>[How does the &#64;property decorator
work?](<a class="reference external" href="http://stackoverflow.com/questions/17330160/how-does-the-property-decorator-work/">http://stackoverflow.com/questions/17330160/how-does-the-property-decorator-work/</a>)</li>
<li><a class="reference external" href="http://stackoverflow.com/questions/3798835/understanding-get-and-set-and-python-descriptors">Understanding get and set and Python
descriptors.</a></li>
</ul>
</li>
</ul>
</div>
</div>

            <aside>
            <nav>
            <ul class="articles_timeline">
 
                <li class="previous_article">« <a href="http://justanr.github.io/python-and-audio-metadata" title="Previous: Python and Audio Metadata">Python and Audio Metadata</a></li>
 
                <li class="next_article"><a href="http://justanr.github.io/code-reuse-in-multiple-forms" title="Next: Code Reuse in Multiple Forms">Code Reuse in Multiple Forms</a> »</li>
            </ul>
            </nav>
            </aside>
<section>
<hr/>
<p id="comment-message">I spilled my brains, spill some of yours. </p>
<div class="accordion" id="accordion2">
    <div class="accordion-group">
        <div class="accordion-heading">
            <a class="accordion-toggle disqus-comment-count" data-toggle="collapse" data-parent="#accordion2" 
                href="http://justanr.github.io/describing-descriptors/#disqus_thread">
                Comments
            </a>
        </div>
        <div id="disqus_thread" class="accordion-body collapse">
            <div class="accordion-inner">
                <div class="comments">
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'ballinoctobear';
        var disqus_identifier = 'http://justanr.github.io/describing-descriptors';
    var disqus_url = 'http://justanr.github.io/describing-descriptors';

    (function() {
         var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
         dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
         (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
     })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>                </div>
            </div>
        </div>
    </div>
</div>
</section>
        </div>
        <section>
        <div class="span2" style="float:right;font-size:0.9em;">
 
            <h4>Published</h4>
            <time pubdate="pubdate" datetime="2014-09-29T00:00:00-04:00">Sep 29, 2014</time>
            <h4>Category</h4>
            <a class="category-link" href="/categories.html#tutorials-ref">tutorials</a> 
            <h4>Tags</h4>
            <ul class="list-of-tags tags-in-article"> 
                <li><a href="/tags.html#descriptors-ref">descriptors
                    <span>3</span>
</a></li>
                <li><a href="/tags.html#python-ref">python
                    <span>17</span>
</a></li>
            </ul>

        </div>
        </section>
    </div>
    </article>
                </div>
                <div class="span1"></div>
            </div>
        </div>
    </div>
<footer>
<div id="footer">
    <ul class="footer-content">
        <li class="elegant-license">Shared under the Creative Commons for content and MIT for code</li>
        <li class="elegant-power">Powered by <a href="http://getpelican.com/" title="Pelican Home Page">Pelican</a>. Theme: <a href="http://oncrashreboot.com/pelican-elegant" title="Theme Elegant Home Page">Elegant</a> by <a href="http://oncrashreboot.com" title="Talha Mansoor Home Page">Talha Mansoor</a></li>
    </ul>
</div>
</footer>            <script src="http://code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/js/bootstrap.min.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

<script type="text/javascript">
    var disqus_shortname = 'ballinoctobear';

    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
    </script>
    </body>
</html>