<!DOCTYPE html>
<html lang="en-US">
    <head>
        <meta charset="utf-8"> 
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="author" content="Alec Nikolas Reiter" />
        <meta name="copyright" content="Alec Nikolas Reiter" />

        <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
        <link rel="stylesheet" href="/theme/slicknav.css">
        <script src="/theme/jquery.slicknav.min.js"></script>
        <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
        <script type="text/javascript"
            src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
        </script>
        <!--[if lt IE 9]>
        <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.6.2/html5shiv.js"></script>
        <![endif]-->


<meta name="keywords" content="python, data processing, tutorials, " />
        <title>Python and Audio Metadata - from alec.thoughts import *
</title>
        <link href="http://cdn-images.mailchimp.com/embedcode/slim-081711.css" rel="stylesheet" type="text/css">
        <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/css/bootstrap-combined.min.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="http://justanr.github.io/theme/css/style.css" media="screen">
        <link rel="stylesheet" type="text/css" href="http://justanr.github.io/theme/css/solarizedlight.css" media="screen">
        <link rel="shortcut icon" href="http://justanr.github.io/theme/images/favicon.ico" type="image/x-icon" />
        <link rel="apple-touch-icon" href="http://justanr.github.io/theme/images/apple-touch-icon.png" />
        <link rel="apple-touch-icon" sizes="57x57" href="http://justanr.github.io/theme/images/apple-touch-icon-57x57.png" />
        <link rel="apple-touch-icon" sizes="72x72" href="http://justanr.github.io/theme/images/apple-touch-icon-72x72.png" />
        <link rel="apple-touch-icon" sizes="114x114" href="http://justanr.github.io/theme/images/apple-touch-icon-114x114.png" />
        <link rel="apple-touch-icon" sizes="144x144" href="http://justanr.github.io/theme/images/apple-touch-icon-144x144.png" />
        <link rel="icon" href="http://justanr.github.io/theme/images/apple-touch-icon-144x144.png" />
    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-64904436-1']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
    </head>
    <body>
        <div id="content-sans-footer">
        <div class="navbar navbar-static-top">
            <div class="navbar-inner">
                <div class="container">
                    <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </a>
                    <a class="brand" href="http://justanr.github.io/"><span class=site-name>from alec.thoughts import *</span></a>
                    <div class="nav-collapse collapse">
                        <ul class="nav pull-right top-menu">
                            <li ><a href="http://justanr.github.io">Home</a></li>
                            <li ><a href="http://justanr.github.io/categories.html">Categories</a></li>
                            <li ><a href="http://justanr.github.io/tags.html">Tags</a></li>
                            <li ><a href="http://justanr.github.io/archives.html">Archives</a></li>
                            <li><form class="navbar-search" action="http://justanr.github.io/search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="container-fluid">
            <div class="row-fluid">
                <div class="span1"></div>
                <div class="span10">
<article>
<div class="row-fluid">
    <header class="page_header span10 offset2">
    <h1><a href="http://justanr.github.io/python-and-audio-metadata"> Python and Audio Metadata  </a></h1>
    </header>
</div>

<div class="row-fluid">
        <div class="span8 offset2 article-content">

            <div class="section" id="metadata-and-you">
<h2>Metadata and You</h2>
<p>You're probably familiar, at least in passing, with the concept of
metadata. It's data about data. In terms of audio files, it's things
like:</p>
<ul class="simple">
<li>Bitrate</li>
<li>Duration/Length</li>
<li>Artist</li>
<li>Album</li>
<li>Track Position (if available)</li>
<li>Year released (if available)</li>
</ul>
<p>Today, I'm using <a class="reference external" href="https://github.com/devsnd/tinytag">TinyTag</a>
(<tt class="docutils literal">pip install tinytag</tt>) to extract metadata (and TinyTag only supports
this), but there's a whole plethora of libraries to extract and set
audio metadata:</p>
<ul class="simple">
<li>Mutagen <a class="reference external" href="https://mutagen.readthedocs.org/en/latest/">docs</a>
<a class="reference external" href="https://bitbucket.org/lazka/mutagen">source</a></li>
<li>eyed3 <a class="reference external" href="http://eyed3.nicfit.net/">docs</a>
<a class="reference external" href="https://bitbucket.org/nicfit/eyed3">source</a></li>
<li>stagger <a class="reference external" href="https://code.google.com/p/stagger/">source</a></li>
</ul>
<div class="section" id="aside">
<h3>Aside</h3>
<p>I actually don't spend a terrible amount of time on actually pulling the
metadata out. It's extremely straightforward with TinyTag. I spend more
time with processing and massaging that data into information we can
really work with. I revisit the cacheing decorator from the decorator
post (and don't follow much of my own advice -- it's kind of a do as I
say, not as I do sort of thing, even then I'm not even really giving
that great of advice) as well as improving on the Artist/Album/Track
mock data models from the API post as well. There's also a little bit
about recursively walking directories and selectively looking for the
files you want.</p>
</div>
</div>
<div class="section" id="becoming-the-nsa-of-your-music">
<h2>Becoming the NSA of your Music</h2>
<p>Getting the metadata is incredibly easy. I'm only going to extract it
from one artist today, but extending this out to covering your whole
library is easy (well, as long as you store your music in one location
and in a reasonable pattern).</p>
<pre class="code ipython3 literal-block">
<span class="kn">from</span> <span class="nn">tinytag</span> <span class="k">import</span> <span class="n">TinyTag</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">os.path</span> <span class="k">as</span> <span class="nn">path</span>

<span class="c1"># audio types TinyTag supports</span>
<span class="n">valid_types</span> <span class="o">=</span> <span class="p">(</span><span class="s1">'mp3'</span><span class="p">,</span> <span class="s1">'ogg'</span><span class="p">,</span> <span class="s1">'oga'</span><span class="p">,</span> <span class="s1">'wav'</span><span class="p">,</span> <span class="s1">'flac'</span><span class="p">)</span>

<span class="c1"># artist directory</span>
<span class="n">acid_bath</span> <span class="o">=</span> <span class="s1">'/home/justanr/Music/Acid Bath/'</span>

<span class="c1">#extract the directories within the artist directory</span>
<span class="n">albums</span> <span class="o">=</span> <span class="p">[</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">acid_bath</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">acid_bath</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="s1">'Demos'</span> <span class="ow">in</span> <span class="n">a</span><span class="p">]</span>

<span class="n">tracks</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># extract tracks from each album directory</span>
<span class="k">for</span> <span class="n">album</span> <span class="ow">in</span> <span class="n">albums</span><span class="p">:</span>
    <span class="n">_tracks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">album</span><span class="p">):</span>
        <span class="c1"># did you know it was possible to pass an iterable to str.endswith?</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">t</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">valid_types</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">_tracks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">album</span><span class="p">,</span> <span class="n">t</span><span class="p">))</span>
    <span class="n">tracks</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_tracks</span><span class="p">)</span>

<span class="k">del</span> <span class="n">_tracks</span> <span class="c1"># no need for hanger-ons.</span>

<span class="c1"># convert track paths to TinyTag objects</span>
<span class="n">tracks</span> <span class="o">=</span> <span class="p">[</span><span class="n">TinyTag</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tracks</span><span class="p">]</span>

<span class="c1"># string representation is actually a</span>
<span class="c1"># string representation of a dictionary</span>
<span class="c1"># created on the fly from the public</span>
<span class="c1"># values on the actual object</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tracks</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre>
<pre class="literal-block">
{'track_total': '14', 'title': 'x03Jezebel', 'filesize': 11915076, 'artist': 'x03Acid Bath', 'album': 'x03When the Kite String Pops', 'track': 'x035', 'audio_offset': 192239, 'bitrate': 320.0, 'year': '1994', 'samplerate': 44100, 'duration': 297.87708785043435}
</pre>
<p>As an aside, if you've never listened to <a class="reference external" href="http://www.metal-archives.com/bands/Acid_Bath/19">Acid
Bath</a>, I can't
recommend them enough. Hard rocking, groovy sludgey metal with lyrics
that are equal parts Lewis Carroll, grotesque and drug binge. Some songs
are more the typical what the layman thinks of metal (Jezebel, Cheap
Vodka) but with songs like Venus Blue, Bleed Me an Ocean and Dead Girl
there's really something for most people.</p>
</div>
<div class="section" id="data-munging-and-you">
<h2>Data Munging and You</h2>
<p>Alright, looks like I have an encoding issue. There is something to note
here though: <tt class="docutils literal">\x03</tt> denotes <tt class="docutils literal">END OF TEXT</tt> and to my understanding
you're suppose to see it in ID3 tags (though, that's based on second
hand information as my search-fu didn't turn up anything). However, I
have actually run into an encoding issue using TinyTag (I'm not sure if
the problem is with the file, Python, IPython or TinyTag). An example:</p>
<pre class="code ipython3 literal-block">
<span class="n">nzp</span> <span class="o">=</span> <span class="n">TinyTag</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'/home/justanr/Music/At the Drive‐In/Relationship of Command/11 Non‐Zero Possibility.mp3'</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">'Expected:      At the Drive-In - Relationship of Command - 11 - Non-Zero Possibility'</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'Actual:       '</span><span class="p">,</span> <span class="s1">' - '</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">nzp</span><span class="o">.</span><span class="n">artist</span><span class="p">,</span> <span class="n">nzp</span><span class="o">.</span><span class="n">album</span><span class="p">,</span> <span class="n">nzp</span><span class="o">.</span><span class="n">track</span><span class="p">,</span> <span class="n">nzp</span><span class="o">.</span><span class="n">title</span><span class="p">]))</span>

<span class="c1"># This is just a bandage.</span>
<span class="c1"># The actual issue is an encoding issue</span>
<span class="c1"># I've not been able to track down.</span>

<span class="c1"># I'd like to thank /u/anossov and /u/ryeguy146</span>
<span class="c1"># for help, even though we all agree this isn't</span>
<span class="c1"># the correct way to address the issue at hand</span>

<span class="k">def</span> <span class="nf">fixer</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">ignore</span><span class="o">=</span><span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">UnicodeEncodeError</span><span class="p">),</span> <span class="n">handle</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">'''Actual fixer function for fix_track

    ignore is a tuple of exceptions we should just discard.
    handle is an optional exception handler.
    '''</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">'latin-1'</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'utf-8'</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="c1"># matching \x03 is frustrating</span>
        <span class="c1"># again, just a crutch to lean on</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isprintable</span><span class="p">():</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">except</span> <span class="n">ignore</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">handle</span><span class="p">:</span>
            <span class="n">handle</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># we always end up here</span>
        <span class="k">return</span> <span class="n">value</span>


<span class="k">def</span> <span class="nf">fix_track</span><span class="p">(</span>
              <span class="n">track</span><span class="p">,</span>
              <span class="n">fixer</span><span class="o">=</span><span class="n">fixer</span><span class="p">,</span>
              <span class="n">fields</span><span class="o">=</span><span class="p">(</span><span class="s1">'artist'</span><span class="p">,</span> <span class="s1">'album'</span><span class="p">,</span> <span class="s1">'title'</span><span class="p">,</span> <span class="s1">'track'</span><span class="p">,</span> <span class="s1">'year'</span><span class="p">,</span> <span class="s1">'track_total'</span><span class="p">),</span>
              <span class="n">int_convert</span><span class="o">=</span><span class="p">(</span><span class="s1">'track'</span><span class="p">,</span> <span class="s1">'year'</span><span class="p">,</span> <span class="s1">'track_total'</span><span class="p">)</span>
              <span class="p">):</span>
    <span class="sd">'''Fix encoding issue encountered on some tracks.

    Accepts a track object and attempts to massage the data in our favor.
    * fixer is the function we want to run on this track to correct data
    * fields in the specific fields we'd like to attempt to correct
    * int_convert is a subset of fields that is data that should be integers
    '''</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">track</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
            <span class="c1"># value is likely None</span>
            <span class="c1"># we'll pass on this value</span>
            <span class="c1"># to avoid blowing up</span>
            <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">fixer</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">int_convert</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">track</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="c1"># TODO: need to make this mutable</span>
    <span class="c1"># for now, it's hardcoded as TinyTag</span>
    <span class="c1"># stores duration as a float</span>
    <span class="n">track</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">track</span><span class="o">.</span><span class="n">duration</span><span class="p">)</span>

    <span class="c1"># returning the track allows us</span>
    <span class="c1"># to be flexible in application</span>
    <span class="c1"># of this function</span>
    <span class="k">return</span> <span class="n">track</span>

<span class="n">nzp</span> <span class="o">=</span> <span class="n">fix_track</span><span class="p">(</span><span class="n">nzp</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'After Fixing: '</span><span class="p">,</span> <span class="s1">' - '</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">nzp</span><span class="o">.</span><span class="n">artist</span><span class="p">,</span> <span class="n">nzp</span><span class="o">.</span><span class="n">album</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">nzp</span><span class="o">.</span><span class="n">track</span><span class="p">),</span> <span class="n">nzp</span><span class="o">.</span><span class="n">title</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">nzp</span><span class="p">)</span>
</pre>
<pre class="literal-block">
Expected:      At the Drive-In - Relationship of Command - 11 - Non-Zero Possibility
Actual:        At the DriveâIn - Relationship of Command - 11 - NonâZero Possibility
After Fixing:  At the Drive‐In - Relationship of Command - 11 - Non‐Zero Possibility
{'track_total': 11, 'title': 'Non‐Zero Possibility', 'filesize': 5382993, 'artist': 'At the Drive‐In', 'album': 'Relationship of Command', 'track': 11, 'audio_offset': 2058, 'bitrate': 128.0, 'year': 2000, 'samplerate': 44100, 'duration': 336}
</pre>
<p>As you can see, encoding issues are <em>painful</em>. This bandage is the best
I can come up with until I can actually track down and address the
issue. However, this works <em>for now</em> (and like so many
<tt class="docutils literal">#TODO: Address actual issue</tt> functions, it'll inevitable end up in my
codebase permanently).</p>
<p>This is an example of <em>data munging</em>. You'll mostly hear that phrase in
machine learning and data processing. But when you think about, isn't
all programming data processing? Data munging is the process of taking
in data and massaging it into a form you can work with. Most of the
time, this involves just converting data from one type to another.
Sometimes it involves just throwing data away and knowing when you
should.</p>
<p>In this case, it's taking a TinyTag object and breaking it into three
separate pieces: Artist, Album and Track data models. Just like in the
API data mocking post, these stand in for actual data models. However,
now, there's a fair bit of magic going on: cacheing, auto registration
of albums and tracks on relevant models, and for good measure: total
ordering.</p>
<p>Cacheing is not done entirely correctly, but do note the use of
<tt class="docutils literal">WeakValueDictionary</tt> which stores weak references. Weak references
allow an object to be garbage collected when it's the only remaining
reference left. Meaning if we created a bunch of Artist objects, stuffed
them into permanent storage somewhere and then deleted the objects (and
all their &quot;strong&quot; references), Python can come clean up some memory for
us. Which is incredibly useful when dealing with a lot of data at once.</p>
<pre class="code ipython3 literal-block">
<span class="kn">import</span> <span class="nn">itertools</span> <span class="k">as</span> <span class="nn">it</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">wraps</span>
<span class="kn">from</span> <span class="nn">weakref</span> <span class="k">import</span> <span class="n">WeakValueDictionary</span>

<span class="c1"># Too lazy to spend time manipulating</span>
<span class="c1"># __new__ or making a metaclass</span>
<span class="c1"># (actually, I spent a lot of time being frustrated at them)</span>
<span class="c1"># to handle this so there's this hack</span>
<span class="k">def</span> <span class="nf">cache</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
    <span class="sd">'''Helper caching and identification methods.'''</span>
    <span class="n">_registry</span> <span class="o">=</span> <span class="n">WeakValueDictionary</span><span class="p">()</span>
    <span class="n">_ids</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">by_name</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_registry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="nd">&#64;wraps</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">nonlocal</span> <span class="n">_registry</span><span class="p">,</span> <span class="n">_ids</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_registry</span><span class="p">:</span>
            <span class="c1"># create a new instance of the class</span>
            <span class="n">instance</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="c1"># generate id for the instance</span>
            <span class="n">instance</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">_ids</span><span class="p">)</span>

            <span class="c1"># register the instance</span>
            <span class="n">_registry</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">instance</span>

        <span class="c1">#reuturn the instance</span>
        <span class="k">return</span> <span class="n">_registry</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
    <span class="n">wrapper</span><span class="o">.</span><span class="n">by_name</span> <span class="o">=</span> <span class="n">by_name</span>
    <span class="k">return</span> <span class="n">wrapper</span>

<span class="k">class</span> <span class="nc">ComparableMixin</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_compare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">method</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cmpkey</span><span class="p">(),</span> <span class="n">other</span><span class="o">.</span><span class="n">_cmpkey</span><span class="p">())</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
            <span class="c1"># _cmpkey not implemented, or return different type,</span>
            <span class="c1"># so I can't compare with &quot;other&quot;.</span>
            <span class="k">return</span> <span class="bp">NotImplemented</span>

    <span class="k">def</span> <span class="nf">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cmpkey</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compare</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">,</span><span class="n">o</span><span class="p">:</span> <span class="n">s</span> <span class="o">&lt;</span> <span class="n">o</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__le__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compare</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">,</span><span class="n">o</span><span class="p">:</span> <span class="n">s</span> <span class="o">&lt;=</span> <span class="n">o</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
       <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compare</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">,</span><span class="n">o</span><span class="p">:</span> <span class="n">s</span> <span class="o">==</span> <span class="n">o</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__ge__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compare</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">,</span><span class="n">o</span><span class="p">:</span> <span class="n">s</span> <span class="o">&gt;=</span> <span class="n">o</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__gt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compare</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">,</span><span class="n">o</span><span class="p">:</span> <span class="n">s</span> <span class="o">&gt;</span> <span class="n">o</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compare</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">,</span><span class="n">o</span><span class="p">:</span> <span class="n">s</span> <span class="o">!=</span> <span class="n">o</span><span class="p">)</span>

<span class="nd">&#64;cache</span>
<span class="k">class</span> <span class="nc">Artist</span><span class="p">(</span><span class="n">ComparableMixin</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">albums</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="c1"># albums should be a list of albums</span>
        <span class="c1"># but it becomes a dictionary</span>
        <span class="c1"># probably shouldn't actually do this</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">albums</span> <span class="o">=</span> <span class="n">albums</span> <span class="ow">or</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">albums</span><span class="p">:</span>
            <span class="n">albums</span> <span class="o">=</span> <span class="p">[</span><span class="n">Album</span><span class="o">.</span><span class="n">by_name</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">albums</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">albums</span> <span class="o">=</span> <span class="p">{</span><span class="n">a</span><span class="o">.</span><span class="n">name</span><span class="p">:</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">albums</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">_cmpkey</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">'''This key is used by ComparableMixin for ordering.
        It is also used for hashing. Including the id is good
        practice here to ensure that we don't accidentally create
        two objects with the same name that makes this useless
        in a hashtable.
        '''</span>

        <span class="c1"># tuples compare across like this:</span>
        <span class="c1"># self[0] op other[0] ... self[n] op other[n]</span>
        <span class="c1"># until the tuples don't match</span>
        <span class="c1"># then Python sorts them accordingly</span>
        <span class="c1"># meaning often the whole tuple doesn't get</span>
        <span class="c1"># compared to another tuple</span>
        <span class="c1"># this is helpful when you want a default</span>
        <span class="c1"># multivalue sort</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;Artist name=</span><span class="si">{}</span><span class="s2"> id=</span><span class="si">{}</span><span class="s2">&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

<span class="nd">&#64;cache</span>
<span class="k">class</span> <span class="nc">Album</span><span class="p">(</span><span class="n">ComparableMixin</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">artist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tracks</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">artist</span> <span class="o">=</span> <span class="n">Artist</span><span class="o">.</span><span class="n">by_name</span><span class="p">(</span><span class="n">artist</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tracks</span> <span class="o">=</span> <span class="n">tracks</span> <span class="ow">or</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">artist</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">artist</span><span class="o">.</span><span class="n">albums</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="n">tracks</span><span class="p">:</span>
            <span class="n">tracks</span> <span class="o">=</span> <span class="p">[</span><span class="n">Track</span><span class="o">.</span><span class="n">by_name</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tracks</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tracks</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tracks</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">t</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_cmpkey</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">artist</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">artist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">artist</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">artist</span> <span class="k">else</span> <span class="s2">&quot;&lt;BLANK&gt;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;Album name=</span><span class="si">{}</span><span class="s2"> artist=</span><span class="si">{}</span><span class="s2"> id=</span><span class="si">{}</span><span class="s2">&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">artist</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

<span class="nd">&#64;cache</span>
<span class="k">class</span> <span class="nc">Track</span><span class="p">(</span><span class="n">ComparableMixin</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">track</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">artist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">album</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">track</span> <span class="o">=</span> <span class="n">track</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">length</span> <span class="c1"># in seconds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">artist</span> <span class="o">=</span> <span class="n">Artist</span><span class="o">.</span><span class="n">by_name</span><span class="p">(</span><span class="n">artist</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">album</span> <span class="o">=</span> <span class="n">Album</span><span class="o">.</span><span class="n">by_name</span><span class="p">(</span><span class="n">album</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">album</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">album</span><span class="o">.</span><span class="n">tracks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_cmpkey</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">album</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">track</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">album</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">album</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">album</span> <span class="k">else</span> <span class="s2">&quot;&lt;BLANK&gt;&quot;</span>
        <span class="n">artist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">artist</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">artist</span> <span class="k">else</span> <span class="s2">&quot;&lt;BLANK&gt;&quot;</span>

        <span class="k">return</span> <span class="s2">&quot;&lt;Track artist=</span><span class="si">{}</span><span class="s2"> album=</span><span class="si">{}</span><span class="s2"> track=</span><span class="si">{}</span><span class="s2"> name=</span><span class="si">{}</span><span class="s2"> id=</span><span class="si">{}</span><span class="s2">&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">artist</span><span class="p">,</span> <span class="n">album</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">track</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

<span class="c1"># Mini unit tests ;)</span>
<span class="c1"># gorguts = Artist(name='Gorguts')</span>
<span class="c1"># obscura = Album(name='Obscura', artist='Gorguts')</span>
<span class="c1"># obscura_track = Track(name=&quot;Obscura&quot;, track=1, length=244, artist=&quot;Gorguts&quot;, album=&quot;Obscura&quot;)</span>
<span class="c1"># assert obscura.artist is gorguts</span>
<span class="c1"># assert obscura.name in gorguts.albums</span>
<span class="c1"># assert obscura_track in obscura.tracks</span>
<span class="c1"># assert obscura == gorguts.albums['Obscura']</span>
<span class="c1"># assert Artist.by_name('blank') is None</span>
<span class="c1"># assert Artist(name='test').id == 2</span>
<span class="c1"># assert Artist(name='Gorguts') is gorguts</span>
<span class="c1"># print(gorguts, obscura, obscura_track)</span>
</pre>
<p>So much hard work taken care of for us with a little magic. The little
unittest at the end is to assure us everything is working as intended.
Uncomment them to see them in action.</p>
<p>The <tt class="docutils literal">Comparable</tt> mixin, I shamelessly
<a class="reference external" href="http://regebro.wordpress.com/2010/12/13/python-implementing-rich-comparison-the-correct-way/">stole</a>,
but it'll make life much easier on the other end of this conversion if
we need to sort a collection of <tt class="docutils literal">Artist</tt>, <tt class="docutils literal">Album</tt> or <tt class="docutils literal">Track</tt>
objects. I added the <tt class="docutils literal">__hash__</tt> method to it. Technically it should be
a <tt class="docutils literal">HashableMixin</tt>, there's already a <em>ton</em> of stuff going on in this
frame, I decided another class would just add to the noise.</p>
<p>Now, we need to massage our list of Acid Bath tracks into these models.
You didn't think I forgot about them, did you?</p>
<pre class="code ipython3 literal-block">
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">namedtuple</span>

<span class="n">tracks</span> <span class="o">=</span> <span class="p">[</span><span class="n">fix_track</span><span class="p">(</span><span class="n">track</span><span class="p">)</span> <span class="k">for</span> <span class="n">track</span> <span class="ow">in</span> <span class="n">tracks</span><span class="p">]</span>

<span class="c1"># our sort and groupby key function</span>
<span class="n">key</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">'key'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'artist'</span><span class="p">,</span> <span class="s1">'album'</span><span class="p">,</span> <span class="s1">'track'</span><span class="p">])</span>
<span class="n">compare</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">key</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">artist</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">album</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">track</span><span class="p">)</span>

<span class="c1"># named after the pattern</span>
<span class="n">adaptor</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="p">{</span><span class="s1">'artist'</span><span class="p">:</span><span class="n">t</span><span class="o">.</span><span class="n">artist</span><span class="p">,</span> <span class="s1">'album'</span><span class="p">:</span><span class="n">t</span><span class="o">.</span><span class="n">album</span><span class="p">,</span> <span class="s1">'length'</span><span class="p">:</span><span class="n">t</span><span class="o">.</span><span class="n">duration</span><span class="p">,</span> <span class="s1">'name'</span><span class="p">:</span><span class="n">t</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="s1">'track'</span><span class="p">:</span><span class="n">t</span><span class="o">.</span><span class="n">track</span><span class="p">}</span>

<span class="n">tracks</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">compare</span><span class="p">)</span>

<span class="c1"># this keeps us from creating a big list</span>
<span class="c1"># with the same artist, albums and tracks</span>
<span class="c1"># over and over by accident</span>
<span class="n">artists</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<span class="n">albums</span>  <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<span class="n">_tracks</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

<span class="k">for</span> <span class="n">keys</span><span class="p">,</span> <span class="n">grouped</span> <span class="ow">in</span> <span class="n">it</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">tracks</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">compare</span><span class="p">):</span>
    <span class="n">artists</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Artist</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">keys</span><span class="o">.</span><span class="n">artist</span><span class="p">))</span>
    <span class="n">albums</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Album</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">keys</span><span class="o">.</span><span class="n">album</span><span class="p">,</span> <span class="n">artist</span><span class="o">=</span><span class="n">keys</span><span class="o">.</span><span class="n">artist</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">track</span> <span class="ow">in</span> <span class="n">grouped</span><span class="p">:</span>
        <span class="n">_tracks</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Track</span><span class="p">(</span><span class="o">**</span><span class="n">adaptor</span><span class="p">(</span><span class="n">track</span><span class="p">)))</span>

<span class="n">artists</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">artists</span><span class="p">)</span>
<span class="n">albums</span>  <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">albums</span><span class="p">)</span>
<span class="n">tracks</span>  <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">_tracks</span><span class="p">)</span>

<span class="c1"># no hanger ons!</span>
<span class="k">del</span> <span class="n">_tracks</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Artists: &quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">artists</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Albums: &quot;</span><span class="p">,</span> <span class="o">*</span><span class="nb">sorted</span><span class="p">(</span><span class="n">albums</span><span class="p">),</span> <span class="n">sep</span><span class="o">=</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Tracks: &quot;</span><span class="p">,</span> <span class="o">*</span><span class="nb">sorted</span><span class="p">(</span><span class="n">tracks</span><span class="p">),</span> <span class="n">sep</span><span class="o">=</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
</pre>
<pre class="literal-block">
Artists:
&lt;Artist name=Acid Bath id=1&gt;

Albums:
&lt;Album name=Paegan Terrorism Tactics artist=Acid Bath id=1&gt;
&lt;Album name=When the Kite String Pops artist=Acid Bath id=2&gt;

Tracks:
&lt;Track artist=Acid Bath album=Paegan Terrorism Tactics track=1 name=Paegan Love Song id=1&gt;
&lt;Track artist=Acid Bath album=Paegan Terrorism Tactics track=2 name=Bleed Me an Ocean id=2&gt;
&lt;Track artist=Acid Bath album=Paegan Terrorism Tactics track=3 name=Graveflower id=3&gt;
&lt;Track artist=Acid Bath album=Paegan Terrorism Tactics track=4 name=Diäb Soulé id=4&gt;
&lt;Track artist=Acid Bath album=Paegan Terrorism Tactics track=5 name=Locust Spawning id=5&gt;
&lt;Track artist=Acid Bath album=Paegan Terrorism Tactics track=6 name=Old Skin id=6&gt;
&lt;Track artist=Acid Bath album=Paegan Terrorism Tactics track=7 name=New Death Sensation id=7&gt;
&lt;Track artist=Acid Bath album=Paegan Terrorism Tactics track=8 name=Venus Blue id=8&gt;
&lt;Track artist=Acid Bath album=Paegan Terrorism Tactics track=9 name=13 Fingers id=9&gt;
&lt;Track artist=Acid Bath album=Paegan Terrorism Tactics track=10 name=New Corpse id=10&gt;
&lt;Track artist=Acid Bath album=Paegan Terrorism Tactics track=11 name=Dead Girl id=11&gt;
&lt;Track artist=Acid Bath album=Paegan Terrorism Tactics track=12 name=Ode of the Peagan id=12&gt;
&lt;Track artist=Acid Bath album=When the Kite String Pops track=1 name=The Blue id=13&gt;
&lt;Track artist=Acid Bath album=When the Kite String Pops track=2 name=Tranquilized id=14&gt;
&lt;Track artist=Acid Bath album=When the Kite String Pops track=3 name=Cheap Vodka id=15&gt;
&lt;Track artist=Acid Bath album=When the Kite String Pops track=4 name=Finger Paintings of the Insane id=16&gt;
&lt;Track artist=Acid Bath album=When the Kite String Pops track=5 name=Jezebel id=17&gt;
&lt;Track artist=Acid Bath album=When the Kite String Pops track=6 name=Scream of the Butterfly id=18&gt;
&lt;Track artist=Acid Bath album=When the Kite String Pops track=7 name=Dr. Seuss Is Dead id=19&gt;
&lt;Track artist=Acid Bath album=When the Kite String Pops track=8 name=Dope Fiend id=20&gt;
&lt;Track artist=Acid Bath album=When the Kite String Pops track=9 name=Toubabo Koomi id=21&gt;
&lt;Track artist=Acid Bath album=When the Kite String Pops track=10 name=God Machine id=22&gt;
&lt;Track artist=Acid Bath album=When the Kite String Pops track=11 name=The Morticians Flame id=23&gt;
&lt;Track artist=Acid Bath album=When the Kite String Pops track=12 name=What Color Is Death id=24&gt;
&lt;Track artist=Acid Bath album=When the Kite String Pops track=13 name=The Bones of Baby Dolls id=25&gt;
&lt;Track artist=Acid Bath album=When the Kite String Pops track=14 name=Cassie Eats Cockroaches id=26&gt;
</pre>
<p>Of course to avoid dealing with &quot;hanger on&quot; variables as I like to call
them, this logic (as well as the logic to take a directory and extract
it's subdirectories and finally the music files in it) could be stored
in a function that'd be callable again and again. Something like this:</p>
<pre class="code ipython3 literal-block">
<span class="k">def</span> <span class="nf">get_music_files</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="n">valid_types</span><span class="o">=</span><span class="p">(</span><span class="s1">'mp3'</span><span class="p">,</span> <span class="s1">'ogg'</span><span class="p">,</span> <span class="s1">'oga'</span><span class="p">,</span> <span class="s1">'wav'</span><span class="p">,</span> <span class="s1">'flac'</span><span class="p">),</span> <span class="n">ignore</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">'''Walks the base directory to extract album directories from it.
    Then walks each album directory to extract valid audio files from it.

    The optional ignore attribute is a callback that allows you to dynamically
    ignore certain directories.
    '''</span>

    <span class="n">tracks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">albums</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">basedir</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ignore</span> <span class="ow">and</span> <span class="n">ignore</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">albums</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="n">a</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">album</span> <span class="ow">in</span> <span class="n">albums</span><span class="p">:</span>
        <span class="n">_tracks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">album</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">t</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">valid_types</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">_tracks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">album</span><span class="p">,</span> <span class="n">t</span><span class="p">))</span>
        <span class="n">tracks</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_tracks</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tracks</span>

<span class="k">def</span> <span class="nf">convert_tinytags</span><span class="p">(</span><span class="n">tracks</span><span class="p">,</span> <span class="n">key_fields</span><span class="o">=</span><span class="p">(</span><span class="s1">'artist'</span><span class="p">,</span> <span class="s1">'album'</span><span class="p">,</span> <span class="s1">'track'</span><span class="p">),</span> <span class="n">adaptor</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">'''Accepts an iterable of TinyTag objects (or similar) and parses them
    into Artist, Album and Track objects.

    * tracks: iterable of track objects
    * key fields: fields used for sorting and grouping the track objects
    * adaptor: optional callback for extracting information from the old
        track objects to create the new track objects
    '''</span>

    <span class="n">key</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">'key'</span><span class="p">,</span> <span class="n">key_fields</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">compare</span><span class="p">(</span><span class="n">track</span><span class="p">):</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">key_fields</span><span class="p">:</span>
            <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">track</span><span class="p">,</span> <span class="n">field</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">key</span><span class="p">(</span><span class="o">*</span><span class="n">values</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">adaptor</span><span class="p">:</span>
        <span class="n">adaptor</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="p">{</span><span class="s1">'artist'</span><span class="p">:</span><span class="n">t</span><span class="o">.</span><span class="n">artist</span><span class="p">,</span> <span class="s1">'album'</span><span class="p">:</span><span class="n">t</span><span class="o">.</span><span class="n">album</span><span class="p">,</span> <span class="s1">'length'</span><span class="p">:</span><span class="n">t</span><span class="o">.</span><span class="n">duration</span><span class="p">,</span> <span class="s1">'name'</span><span class="p">:</span><span class="n">t</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="s1">'track'</span><span class="p">:</span><span class="n">t</span><span class="o">.</span><span class="n">track</span><span class="p">}</span>

    <span class="n">tracks</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">compare</span><span class="p">)</span>

    <span class="c1"># this keeps us from creating a big list</span>
    <span class="c1"># with the same artist and albums over and over</span>
    <span class="n">artists</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">albums</span>  <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">_tracks</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">keys</span><span class="p">,</span> <span class="n">grouped</span> <span class="ow">in</span> <span class="n">it</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">tracks</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">compare</span><span class="p">):</span>
        <span class="n">artists</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Artist</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">keys</span><span class="o">.</span><span class="n">artist</span><span class="p">))</span>
        <span class="n">albums</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Album</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">keys</span><span class="o">.</span><span class="n">album</span><span class="p">,</span> <span class="n">artist</span><span class="o">=</span><span class="n">keys</span><span class="o">.</span><span class="n">artist</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">track</span> <span class="ow">in</span> <span class="n">grouped</span><span class="p">:</span>
            <span class="n">_tracks</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Track</span><span class="p">(</span><span class="o">**</span><span class="n">adaptor</span><span class="p">(</span><span class="n">track</span><span class="p">)))</span>

    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">artists</span><span class="p">),</span> <span class="nb">list</span><span class="p">(</span><span class="n">albums</span><span class="p">),</span> <span class="nb">list</span><span class="p">(</span><span class="n">_tracks</span><span class="p">)</span>

<span class="n">tracks</span> <span class="o">=</span> <span class="n">get_music_files</span><span class="p">(</span><span class="s1">'/home/justanr/Music/At the Drive‐In/'</span><span class="p">)</span>
<span class="n">tracks</span> <span class="o">=</span> <span class="p">[</span><span class="n">TinyTag</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tracks</span><span class="p">]</span>
<span class="n">tracks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">fix_track</span><span class="p">,</span> <span class="n">tracks</span><span class="p">))</span>
<span class="n">artists</span><span class="p">,</span> <span class="n">albums</span><span class="p">,</span> <span class="n">tracks</span> <span class="o">=</span> <span class="n">convert_tinytags</span><span class="p">(</span><span class="n">tracks</span><span class="p">)</span>

<span class="c1"># of course you could just:</span>
<span class="c1"># artists, albums, tracks = convert_tinytags([fix_track(TinyTag.get(t)) for t in get_music_files(...)])</span>
<span class="c1"># But that's also pretty hard to read, too</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Artists: &quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">artists</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Albums: &quot;</span><span class="p">,</span> <span class="o">*</span><span class="nb">sorted</span><span class="p">(</span><span class="n">albums</span><span class="p">),</span> <span class="n">sep</span><span class="o">=</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Tracks: &quot;</span><span class="p">,</span> <span class="o">*</span><span class="nb">sorted</span><span class="p">(</span><span class="n">tracks</span><span class="p">),</span> <span class="n">sep</span><span class="o">=</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
</pre>
<pre class="literal-block">
Artists:
&lt;Artist name=At the Drive‐In id=2&gt;

Albums:
&lt;Album name=Relationship of Command artist=At the Drive‐In id=3&gt;
&lt;Album name=Vaya artist=At the Drive‐In id=4&gt;

Tracks:
&lt;Track artist=At the Drive‐In album=Relationship of Command track=1 name=Arcarsenal id=27&gt;
&lt;Track artist=At the Drive‐In album=Relationship of Command track=2 name=Pattern Against User id=28&gt;
&lt;Track artist=At the Drive‐In album=Relationship of Command track=3 name=One Armed Scissor id=29&gt;
&lt;Track artist=At the Drive‐In album=Relationship of Command track=4 name=Sleepwalk Capsules id=30&gt;
&lt;Track artist=At the Drive‐In album=Relationship of Command track=5 name=Invalid Litter Dept. id=31&gt;
&lt;Track artist=At the Drive‐In album=Relationship of Command track=6 name=Mannequin Republic id=32&gt;
&lt;Track artist=At the Drive‐In album=Relationship of Command track=7 name=Enfilade id=33&gt;
&lt;Track artist=At the Drive‐In album=Relationship of Command track=8 name=Rolodex Propaganda id=34&gt;
&lt;Track artist=At the Drive‐In album=Relationship of Command track=9 name=Quarantined id=35&gt;
&lt;Track artist=At the Drive‐In album=Relationship of Command track=10 name=Cosmonaut id=36&gt;
&lt;Track artist=At the Drive‐In album=Relationship of Command track=11 name=Non‐Zero Possibility id=37&gt;
&lt;Track artist=At the Drive‐In album=Vaya track=1 name=Rascuache id=38&gt;
&lt;Track artist=At the Drive‐In album=Vaya track=2 name=Proxima Centauri id=39&gt;
&lt;Track artist=At the Drive‐In album=Vaya track=3 name=Ursa Minor id=40&gt;
&lt;Track artist=At the Drive‐In album=Vaya track=4 name=Heliotrope id=41&gt;
&lt;Track artist=At the Drive‐In album=Vaya track=5 name=Metronome Arthritis id=42&gt;
&lt;Track artist=At the Drive‐In album=Vaya track=6 name=300 MHz id=43&gt;
&lt;Track artist=At the Drive‐In album=Vaya track=7 name=198d id=44&gt;
</pre>
<p>Of course, we could generalize <tt class="docutils literal">get_music_files</tt> to recursively walk
the base Music directory so it's not confined to my organizational
scheme.</p>
<pre class="code ipython3 literal-block">
<span class="k">def</span> <span class="nf">r_get_music_files</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="n">valid_types</span><span class="o">=</span><span class="p">(</span><span class="s1">'mp3'</span><span class="p">,</span> <span class="s1">'ogg'</span><span class="p">,</span> <span class="s1">'oga'</span><span class="p">,</span> <span class="s1">'wav'</span><span class="p">,</span> <span class="s1">'flac'</span><span class="p">),</span> <span class="n">ignore</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">tracks</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">basedir</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="c1"># we can now filter both directories and files</span>
        <span class="c1"># passing the full path will even allow</span>
        <span class="c1"># ignore to filter based on if `f` is</span>
        <span class="c1"># a directory or file</span>
        <span class="k">if</span> <span class="n">ignore</span> <span class="ow">and</span> <span class="n">ignore</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">elif</span> <span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
            <span class="n">tracks</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">r_get_music_files</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">valid_types</span><span class="p">,</span> <span class="n">ignore</span><span class="p">))</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">valid_types</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># must be a file we're looking for</span>
            <span class="n">tracks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tracks</span>

<span class="c1"># only going to point this at a artist directory</span>
<span class="c1"># the `An Awesome Wave` album is a directory in here</span>
<span class="c1"># just to demonstrate that this does in fact work as intended</span>
<span class="n">tracks</span> <span class="o">=</span> <span class="n">r_get_music_files</span><span class="p">(</span><span class="s1">'/home/justanr/Music/Alt-J/'</span><span class="p">)</span>
<span class="n">tracks</span> <span class="o">=</span> <span class="p">[</span><span class="n">TinyTag</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tracks</span><span class="p">]</span>
<span class="n">tracks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">fix_track</span><span class="p">,</span> <span class="n">tracks</span><span class="p">))</span>
<span class="n">artists</span><span class="p">,</span> <span class="n">albums</span><span class="p">,</span> <span class="n">tracks</span> <span class="o">=</span> <span class="n">convert_tinytags</span><span class="p">(</span><span class="n">tracks</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Artists: &quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">artists</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Albums: &quot;</span><span class="p">,</span> <span class="o">*</span><span class="nb">sorted</span><span class="p">(</span><span class="n">albums</span><span class="p">),</span> <span class="n">sep</span><span class="o">=</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Tracks: &quot;</span><span class="p">,</span> <span class="o">*</span><span class="nb">sorted</span><span class="p">(</span><span class="n">tracks</span><span class="p">),</span> <span class="n">sep</span><span class="o">=</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
</pre>
<pre class="literal-block">
Artists:
&lt;Artist name=Alt-J id=3&gt;

Albums:
&lt;Album name=An Awesome Wave artist=Alt-J id=5&gt;

Tracks:
&lt;Track artist=Alt-J album=An Awesome Wave track=1 name=Intro id=45&gt;
&lt;Track artist=Alt-J album=An Awesome Wave track=2 name=Intrelude 1 id=46&gt;
&lt;Track artist=Alt-J album=An Awesome Wave track=3 name=Tesselate id=47&gt;
&lt;Track artist=Alt-J album=An Awesome Wave track=4 name=Breezeblocks id=48&gt;
&lt;Track artist=Alt-J album=An Awesome Wave track=5 name=Interlude 2 id=49&gt;
&lt;Track artist=Alt-J album=An Awesome Wave track=6 name=Something Good id=50&gt;
&lt;Track artist=Alt-J album=An Awesome Wave track=7 name=Disolve Me id=51&gt;
&lt;Track artist=Alt-J album=An Awesome Wave track=8 name=Matilda id=52&gt;
&lt;Track artist=Alt-J album=An Awesome Wave track=9 name=Ms id=53&gt;
&lt;Track artist=Alt-J album=An Awesome Wave track=10 name=Fitzpleasure id=54&gt;
&lt;Track artist=Alt-J album=An Awesome Wave track=11 name=Interlude 3 id=55&gt;
&lt;Track artist=Alt-J album=An Awesome Wave track=12 name=Bloodflow id=56&gt;
&lt;Track artist=Alt-J album=An Awesome Wave track=13 name=Taro id=57&gt;
</pre>
<p>That works, but it's recursive (in a bad way). And it stores everything
<em>in memory</em>. Yuck. I have approximately 26,000 or so audio files
chilling in my music directory. Do we really want to store all that
information all at once when the ultimate goal is to simlply stuff it in
the database (did I give away my plan?) and throw the immediate result
away.</p>
<p>You know what's really good at doing something and then throwing results
away? Generators. Adapting <tt class="docutils literal">r_get_music_files</tt> to a general file
walker is trivial but I'm slightly vain and overly happy with my end
generator. Before anyone jumps on me and says, &quot;ALEC! There's os.walk!
You've got os imported already!&quot;</p>
<p>I know. <tt class="docutils literal">os.walk</tt> almost does what we want: start with a folder, find
the subfolders, yield a list of things. Except in this case it's three
tuples: <tt class="docutils literal">(dirpath, dirnames, filenames)</tt>. Which means we need to then
parse that before getting to what we want. We could also use glob for
this -- iglob uses an iterator -- but that delves into using regular
expressions. There's <tt class="docutils literal">pathlib</tt> in 3.4, but I'm ultimately unfamilar
with it.</p>
<pre class="code ipython3 literal-block">
<span class="k">def</span> <span class="nf">walk</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="n">ignore</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">basedir</span><span class="p">)):</span>
        <span class="c1"># store fullpath separately so we can</span>
        <span class="c1"># easily pass it if needed</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ignore</span> <span class="ow">and</span> <span class="n">ignore</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">fp</span><span class="p">):</span>
            <span class="c1"># to quote Dave Beazley:</span>
            <span class="c1"># &quot;Yield from is the ultimate not my problem.</span>
            <span class="c1"># It just says, 'Here's some generator, you deal with it.'&quot;</span>
            <span class="k">yield from</span> <span class="n">walk</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">ignore</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># must be a file we're looking for</span>
            <span class="k">yield</span> <span class="n">fp</span>

<span class="k">def</span> <span class="nf">ignore</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">valid_types</span><span class="o">=</span><span class="p">(</span><span class="s1">'.mp3'</span><span class="p">,</span> <span class="s1">'.ogg'</span><span class="p">,</span> <span class="s1">'.oga'</span><span class="p">,</span> <span class="s1">'.wav'</span><span class="p">,</span> <span class="s1">'.flac'</span><span class="p">)):</span>
    <span class="sd">'''Example ignore function.'''</span>
    <span class="n">fp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
    <span class="c1"># ignore 'hidden' files and directories</span>
    <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">'.'</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="c1"># filter actual files based on their extension</span>
    <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">valid_types</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="c1"># got here, so we return False to *not* ignore this file</span>
    <span class="c1"># a little confusing</span>
    <span class="c1"># also, I don't like if/elif without a else</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

<span class="c1"># breaking the adaptor fully out into it's own function as well</span>
<span class="c1"># even though for this example we're dealing exclusively with</span>
<span class="c1"># TinyTag, I did give links to several other metadata libraries</span>
<span class="c1"># maybe you're dealing with one of those?</span>
<span class="n">adaptor</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="p">{</span><span class="s1">'artist'</span><span class="p">:</span><span class="n">t</span><span class="o">.</span><span class="n">artist</span><span class="p">,</span> <span class="s1">'album'</span><span class="p">:</span><span class="n">t</span><span class="o">.</span><span class="n">album</span><span class="p">,</span> <span class="s1">'length'</span><span class="p">:</span><span class="n">t</span><span class="o">.</span><span class="n">duration</span><span class="p">,</span> <span class="s1">'name'</span><span class="p">:</span><span class="n">t</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="s1">'track'</span><span class="p">:</span><span class="n">t</span><span class="o">.</span><span class="n">track</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">convert_track</span><span class="p">(</span><span class="n">track</span><span class="p">,</span> <span class="n">adaptor</span><span class="p">):</span>
    <span class="n">info</span> <span class="o">=</span> <span class="n">adaptor</span><span class="p">(</span><span class="n">track</span><span class="p">)</span>
    <span class="n">artist</span> <span class="o">=</span> <span class="n">Artist</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">info</span><span class="p">[</span><span class="s1">'artist'</span><span class="p">])</span>
    <span class="n">album</span> <span class="o">=</span> <span class="n">Album</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">info</span><span class="p">[</span><span class="s1">'album'</span><span class="p">],</span> <span class="n">artist</span><span class="o">=</span><span class="n">info</span><span class="p">[</span><span class="s1">'artist'</span><span class="p">])</span>
    <span class="n">track</span> <span class="o">=</span> <span class="n">Track</span><span class="p">(</span><span class="o">**</span><span class="n">info</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">artist</span><span class="p">,</span> <span class="n">album</span><span class="p">,</span> <span class="n">track</span>

<span class="o">%</span><span class="k">timeit</span> -n 100 -r 5 next(walk('/home/justanr/Music/', ignore=ignore))
<span class="o">%</span><span class="k">timeit</span> -n 100 -r 5 next(os.walk('/home/justanr/Music'))
<span class="n">track</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">walk</span><span class="p">(</span><span class="s1">'/home/justanr/Music/'</span><span class="p">,</span> <span class="n">ignore</span><span class="o">=</span><span class="n">ignore</span><span class="p">))</span>
<span class="n">track</span> <span class="o">=</span> <span class="n">TinyTag</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">track</span><span class="p">)</span>
<span class="n">track</span> <span class="o">=</span> <span class="n">fix_track</span><span class="p">(</span><span class="n">track</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="o">*</span><span class="n">convert_track</span><span class="p">(</span><span class="n">track</span><span class="p">,</span> <span class="n">adaptor</span><span class="p">),</span> <span class="n">sep</span><span class="o">=</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
</pre>
<pre class="literal-block">
100 loops, best of 5: 295 µs per loop
100 loops, best of 5: 1.34 ms per loop
&lt;Artist name=16 id=4&gt;
&lt;Album name=Bridges to Burn artist=16 id=6&gt;
&lt;Track artist=16 album=Bridges to Burn track=1 name=Throw in the Towel id=58&gt;
</pre>
<p>It's still procedural code but it's nicely composable. And it's quick.
In this particular instance, it's faster than os.walk but I've always
thought benchmarks are useless without a greater context -- so for shits
and giggles, I ran both over my Music directory (with all 26,000+
files), just spitting values into 0 length deque, and my walk function
took about ~560ms, os.walk took ~350ms. Considering we're doing a little
more work than os.walk, I'll take it any day of the week.</p>
<p>And even though convert_track only accepts one track now, chunking over
walk with <tt class="docutils literal">islice</tt> is obvious.</p>
<p>Now that I've digressed completely from audio metadata to quickly
processing through files, I think I'll end here.</p>
</div>

            <aside>
            <nav>
            <ul class="articles_timeline">
 
                <li class="previous_article">« <a href="http://justanr.github.io/decorator-day" title="Previous: Decorator Day">Decorator Day</a></li>
 
                <li class="next_article"><a href="http://justanr.github.io/describing-descriptors" title="Next: Describing Descriptors">Describing Descriptors</a> »</li>
            </ul>
            </nav>
            </aside>
<section>
<hr/>
<p id="comment-message">I spilled my brains, spill some of yours. </p>
<div class="accordion" id="accordion2">
    <div class="accordion-group">
        <div class="accordion-heading">
            <a class="accordion-toggle disqus-comment-count" data-toggle="collapse" data-parent="#accordion2" 
                href="http://justanr.github.io/python-and-audio-metadata/#disqus_thread">
                Comments
            </a>
        </div>
        <div id="disqus_thread" class="accordion-body collapse">
            <div class="accordion-inner">
                <div class="comments">
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'ballinoctobear';
        var disqus_identifier = 'http://justanr.github.io/python-and-audio-metadata';
    var disqus_url = 'http://justanr.github.io/python-and-audio-metadata';

    (function() {
         var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
         dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
         (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
     })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>                </div>
            </div>
        </div>
    </div>
</div>
</section>
        </div>
        <section>
        <div class="span2" style="float:right;font-size:0.9em;">
 
            <h4>Published</h4>
            <time pubdate="pubdate" datetime="2014-08-24T00:00:00-04:00">Aug 24, 2014</time>
            <h4>Category</h4>
            <a class="category-link" href="/categories.html#tutorials-ref">tutorials</a> 
            <h4>Tags</h4>
            <ul class="list-of-tags tags-in-article"> 
                <li><a href="/tags.html#data-processing-ref">data processing
                    <span>1</span>
</a></li>
                <li><a href="/tags.html#python-ref">python
                    <span>17</span>
</a></li>
            </ul>

        </div>
        </section>
    </div>
    </article>
                </div>
                <div class="span1"></div>
            </div>
        </div>
    </div>
<footer>
<div id="footer">
    <ul class="footer-content">
        <li class="elegant-license">Shared under the Creative Commons for content and MIT for code</li>
        <li class="elegant-power">Powered by <a href="http://getpelican.com/" title="Pelican Home Page">Pelican</a>. Theme: <a href="http://oncrashreboot.com/pelican-elegant" title="Theme Elegant Home Page">Elegant</a> by <a href="http://oncrashreboot.com" title="Talha Mansoor Home Page">Talha Mansoor</a></li>
    </ul>
</div>
</footer>            <script src="http://code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/js/bootstrap.min.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

<script type="text/javascript">
    var disqus_shortname = 'ballinoctobear';

    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
    </script>
    </body>
</html>