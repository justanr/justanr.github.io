<!DOCTYPE html>
<html lang="en-US">
    <head>
        <meta charset="utf-8"> 
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="author" content="Alec Nikolas Reiter" />
        <meta name="copyright" content="Alec Nikolas Reiter" />

        <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
        <link rel="stylesheet" href="/theme/slicknav.css">
        <script src="/theme/jquery.slicknav.min.js"></script>
        <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
        <script type="text/javascript"
            src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
        </script>
        <!--[if lt IE 9]>
        <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.6.2/html5shiv.js"></script>
        <![endif]-->


<meta name="keywords" content="python, flask, design, " />
        <title>Exploring Code Architecture - from alec.thoughts import *
</title>
        <link href="http://cdn-images.mailchimp.com/embedcode/slim-081711.css" rel="stylesheet" type="text/css">
        <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/css/bootstrap-combined.min.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="http://justanr.github.io/theme/css/style.css" media="screen">
        <link rel="stylesheet" type="text/css" href="http://justanr.github.io/theme/css/solarizedlight.css" media="screen">
        <link rel="shortcut icon" href="http://justanr.github.io/theme/images/favicon.ico" type="image/x-icon" />
        <link rel="apple-touch-icon" href="http://justanr.github.io/theme/images/apple-touch-icon.png" />
        <link rel="apple-touch-icon" sizes="57x57" href="http://justanr.github.io/theme/images/apple-touch-icon-57x57.png" />
        <link rel="apple-touch-icon" sizes="72x72" href="http://justanr.github.io/theme/images/apple-touch-icon-72x72.png" />
        <link rel="apple-touch-icon" sizes="114x114" href="http://justanr.github.io/theme/images/apple-touch-icon-114x114.png" />
        <link rel="apple-touch-icon" sizes="144x144" href="http://justanr.github.io/theme/images/apple-touch-icon-144x144.png" />
        <link rel="icon" href="http://justanr.github.io/theme/images/apple-touch-icon-144x144.png" />
    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-64904436-1']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
    </head>
    <body>
        <div id="content-sans-footer">
        <div class="navbar navbar-static-top">
            <div class="navbar-inner">
                <div class="container">
                    <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </a>
                    <a class="brand" href="http://justanr.github.io/"><span class=site-name>from alec.thoughts import *</span></a>
                    <div class="nav-collapse collapse">
                        <ul class="nav pull-right top-menu">
                            <li ><a href="http://justanr.github.io">Home</a></li>
                            <li ><a href="http://justanr.github.io/categories.html">Categories</a></li>
                            <li ><a href="http://justanr.github.io/tags.html">Tags</a></li>
                            <li ><a href="http://justanr.github.io/archives.html">Archives</a></li>
                            <li><form class="navbar-search" action="http://justanr.github.io/search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="container-fluid">
            <div class="row-fluid">
                <div class="span1"></div>
                <div class="span10">
<article>
<div class="row-fluid">
    <header class="page_header span10 offset2">
    <h1><a href="http://justanr.github.io/exploring-code-architecture"> Exploring Code Architecture  </a></h1>
    </header>
</div>

<div class="row-fluid">
        <div class="span8 offset2 article-content">

            <p>I've been thinking quite a bit about architecture lately. Not building
architecture, but application architecture. The inspiration for this has
been many blog posts, talks, slide decks and books, and I'd like to take
the time to share my take on what I've been learning. And to do that, I
sat down with one of my projects and looked for the most boring, mundane
parts of it: logging in.</p>
<p>Right, because who wants to write log in forms and code again? Anyways,
this is what I started with:</p>
<pre class="code ipython3 literal-block">
<span class="nd">&#64;app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">'/login'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">'POST'</span><span class="p">,</span> <span class="s1">'GET'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">login</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">'homepage'</span><span class="p">))</span>

    <span class="n">form</span> <span class="o">=</span> <span class="n">LoginForm</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">validate_on_submit</span><span class="p">():</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">or_</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="n">form</span><span class="o">.</span><span class="n">login</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                        <span class="n">User</span><span class="o">.</span><span class="n">email</span> <span class="o">==</span> <span class="n">form</span><span class="o">.</span><span class="n">login</span><span class="o">.</span><span class="n">data</span><span class="p">))</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">user</span> <span class="ow">and</span> <span class="n">check_password_hash</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">password</span><span class="p">,</span> <span class="n">form</span><span class="o">.</span><span class="n">password</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
            <span class="n">login_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
            <span class="n">flash</span><span class="p">(</span><span class="s2">&quot;thank you for logging in&quot;</span><span class="p">,</span> <span class="s1">'success'</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">'user.profile'</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">))</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">flash</span><span class="p">(</span><span class="s2">&quot;Bad username/password combination&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s2">&quot;login.html&quot;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">)</span>
</pre>
<p>That's actually pretty standard across web apps I've seen. You don't let
logged in users log back in (though, I have seen apps that occasionally
need a user to reauthenticate), there's some webform that we'll pull
data off of. Next, we'll try pulling user data for either the username
or email provided and then check if the password typed in matches the
user's password hash. If it's all good, we redirect off somewhere
otherwise there's some HTML rendered.</p>
<p>Big whoop right. However, this is actual logic for the application. But
it's all shoved into an endpoint which is essentially UI logic. And
imagine testing this, we need to contend with:</p>
<ol class="arabic simple">
<li>A thread local (<tt class="docutils literal">current_user</tt>)</li>
<li>Form data</li>
<li>Database</li>
<li>Werkzeug's password checker</li>
<li>Message flashing</li>
<li>Flask's url routing -- both <tt class="docutils literal">url_for</tt> and <tt class="docutils literal">redirect</tt></li>
<li>Templating</li>
<li>Creating the form</li>
<li>Multiple exit branches</li>
<li>A nested if statement</li>
<li>Actually logging in the user</li>
<li>The difference between GET and POST requests</li>
</ol>
<p>That's too many things too many to deal with at once. &quot;But Alec, there's
<tt class="docutils literal">unittest.mock</tt>!&quot; If we're going to go that route, we need to have a
pile of <tt class="docutils literal">mock.patch</tt> decorators and context managers and there's the
real chance we just end up creating some meaningless assertion. Like
this...</p>
<pre class="code ipython3 literal-block">
<span class="nd">&#64;mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">'myapp.auth.views.current_user'</span><span class="p">)</span>
<span class="nd">&#64;mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">'myapp.auth.views.LoginForm'</span><span class="p">)</span>
<span class="nd">&#64;mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">'myapp.auth.views.User'</span><span class="p">)</span>
<span class="nd">&#64;mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">'myapp.auth.views.flash'</span><span class="p">)</span>
<span class="nd">&#64;mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">'myapp.auth.views.url_for'</span><span class="p">)</span>
<span class="nd">&#64;mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">'myapp.auth.views.redirect'</span><span class="p">)</span>
<span class="nd">&#64;mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">'myapp.auth.views.render'</span><span class="p">)</span>
<span class="nd">&#64;mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">'myapp.auth.views.login_user'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_login_user_endpoint</span><span class="p">(</span><span class="n">login_user</span><span class="p">,</span> <span class="n">render</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">url_for</span><span class="p">,</span> <span class="n">flash</span><span class="p">,</span> <span class="n">UserModel</span><span class="p">,</span> <span class="n">form</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
    <span class="c1">#TODO: Write test</span>
    <span class="k">assert</span> <span class="kc">True</span>
</pre>
<p>How do we even begin munging and manipulating those mocks into any sort
of meaningful test? If you have an endpoint like this that's tested and
you didn't end writing tests that basically assert that <tt class="docutils literal">mock.patch</tt>
works, I applaud you.</p>
<p>An acceptance test might be a good fit here to assert the general
behavior. Insert a user in the database and then run the function and
assert the user is actually logged in at the end of it, insert some user
in the database and submit a bad password as part of the form and assert
the template is rendered with the flashed message, etc.</p>
<p>And I'd probably recommend that (I didn't do it in this particular
instance though) to make sure the functionality of the endpoint is
preserved without asserting any fine grained details. With an acceptance
test we want to see a forest, not trees. But there's actual reusable
components that are obscured by simply shoving everything into the end
point. So, let's find them and make them citizens in the application.</p>
<div class="section" id="mise-en-place">
<h2>Mise en place</h2>
<p><a class="reference external" href="http://codingwithkniv.es/2014/08/14/exercise-zero-the-setup-mise-en-place/">Adrienne, a friend of mine, has an excellent blog post comparing
cooking preperations with coding
preperations.</a>
And I think it applies to more than just preparing to code, when we're
refactoring, especially with the goal of unjamming an endpoint, it's
important to lay out some goals and examine what we're dealing with.</p>
<p>And in this case, we already did that already. We know what the goal is
and we know all the things our endpoint touches to do its work.</p>
<p>Let's start with the last concern I listed out as it's the most obvious
seam: we handle GET and POST request separately. If it's a GET request,
only render a template. If it's a POST request, run the actual logic and
then either render or redirect.</p>
<p>Currently, we silently treat the idea of <tt class="docutils literal">GET</tt> and <tt class="docutils literal">POST</tt> separately
with the use of <tt class="docutils literal">validate_on_submit</tt>. However, Flask (and other
frameworks) provide a way of explicitly declaring the difference without
a series of if-statements. In Flask, we call it <tt class="docutils literal">MethodView</tt>, and we
can simply define separate methods for each HTTP Verb.</p>
<pre class="code ipython3 literal-block">
<span class="kn">from</span> <span class="nn">flask.views</span> <span class="k">import</span> <span class="n">MethodView</span>

<span class="k">class</span> <span class="nc">LoginController</span><span class="p">(</span><span class="n">MethodView</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">'login.html'</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">LoginForm</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">LoginForm</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">validate_on_submit</span><span class="p">():</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">or_</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="n">form</span><span class="o">.</span><span class="n">login</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                            <span class="n">User</span><span class="o">.</span><span class="n">email</span> <span class="o">==</span> <span class="n">form</span><span class="o">.</span><span class="n">login</span><span class="o">.</span><span class="n">data</span><span class="p">))</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">user</span> <span class="ow">and</span> <span class="n">check_password_hash</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">password</span><span class="p">,</span> <span class="n">form</span><span class="o">.</span><span class="n">password</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
                <span class="n">login_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
                <span class="n">flash</span><span class="p">(</span><span class="s2">&quot;thank you for logging in&quot;</span><span class="p">,</span> <span class="s2">&quot;success&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">'user.profile'</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">))</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">flash</span><span class="p">(</span><span class="s2">&quot;Bad username/password combination&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">'login.html'</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">)</span>
</pre>
<p>Right now, we've broken one of our imaginary acceptance tests:
&quot;Authenticated users cannot re-log in&quot;. However, there's an easy fix,
<tt class="docutils literal">MethodView</tt> (and it's parent <tt class="docutils literal">View</tt>) allow us to provide decorators
that are used at run time when the actual view function is generated. So
we can take that little if-check and turn it into a function...</p>
<pre class="code ipython3 literal-block">
<span class="k">def</span> <span class="nf">disallow_authenticated</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="nd">&#64;wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">checker</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">'homepage'</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">checker</span>
</pre>
<p>And then stuff it in as a class attribute...</p>
<pre class="code ipython3 literal-block">
<span class="k">class</span> <span class="nc">LoginController</span><span class="p">(</span><span class="n">MethodView</span><span class="p">):</span>
    <span class="n">decorators</span> <span class="o">=</span> <span class="p">[</span><span class="n">disallow_authenticated</span><span class="p">]</span>
</pre>
<p>Already this is slightly more testable. Not much, but we can write a
test against <tt class="docutils literal">disallow_authenticated</tt> that doesn't involve
<tt class="docutils literal">LoginUser</tt> and vice-versa -- these decorators are only applied when
the <tt class="docutils literal">as_view</tt> factory method is used. There's a little bit of
refactoring we can do as well, we instantiate the actual form in two
different spots and we do the rendering in two different spots as well:</p>
<pre class="code ipython3 literal-block">
<span class="k">class</span> <span class="nc">LoginController</span><span class="p">(</span><span class="n">MethodView</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">form</span> <span class="o">=</span> <span class="n">LoginForm</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">validate_on_submit</span><span class="p">():</span>
            <span class="o">...</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">'login.html'</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>
</pre>
</div>
<div class="section" id="actually-authenticating">
<h2>Actually Authenticating</h2>
<p>However, there's still lots of logic inside the endpoint: we
authenticate and login the user. Let's first extract that out into its
own thing so we can examine it closer:</p>
<pre class="code ipython3 literal-block">
<span class="k">def</span> <span class="nf">log_in_user</span><span class="p">(</span><span class="n">login</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">or_</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="n">login</span><span class="p">,</span>
                                            <span class="n">User</span><span class="o">.</span><span class="n">email</span> <span class="o">==</span> <span class="n">login</span><span class="p">))</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">user</span> <span class="ow">and</span> <span class="n">check_password_hash</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">password</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
        <span class="n">login_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</pre>
<p>We're missing the failure case, but we can address that. There's two
ways to handle this:</p>
<ol class="arabic simple">
<li>Error codes</li>
<li>Exceptions</li>
</ol>
<p>I like exceptions because they're really loud, unlike error code which
can silently pass. Exceptions <em>must</em> be dealt with or the application
crashes. However, there's solid arguments for both styles, pick the one
the fits your brain best.</p>
<pre class="code ipython3 literal-block">
<span class="k">class</span> <span class="nc">AuthenticationError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">def</span> <span class="nf">log_in_user</span><span class="p">(</span><span class="n">login</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">AuthenticationError</span><span class="p">(</span><span class="s2">&quot;Bad login credentials&quot;</span><span class="p">)</span>
</pre>
<p>And whatever calls this will deal with the exception. We'll get back to
that later though. So the actual story for this function looks like
this:</p>
<ol class="arabic simple">
<li>Locate a user with either the provided username or email</li>
<li>If we find the user, check that the provided password matches the
user's stored password hash</li>
<li>If those match, login in the user</li>
<li>If a user can't be found or the passwords do not match, raise an
error</li>
</ol>
<p>Notice that we don't say anything about <em>how</em> to find the user, just
that we need to. Realizing this sent a shiver down my spine: I don't
actually care about the database, I care about the data it stores.
Honestly, this data could come from anywhere: database, Redis, flatfile,
a hash table, remote API, etc. And the next step was a leap of faith for
me: stick an interface there.</p>
<pre class="code ipython3 literal-block">
<span class="k">def</span> <span class="nf">locate_by_username_or_email</span><span class="p">(</span><span class="n">login</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">or_</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="n">login</span><span class="p">,</span> <span class="n">User</span><span class="o">.</span><span class="n">email</span> <span class="o">==</span> <span class="n">login</span><span class="p">))</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</pre>
<p>And then, somehow, inject that into the log_in_user function. Why we
want to inject it is to remove the dependency from the database and
instead depend on the contract: either return a user object or a None.
We should do the same with the password hash validator so we can depend
on that interface rather than Werkzeug. Since we don't want to have to
do it every time, we could use a closure:</p>
<pre class="code ipython3 literal-block">
<span class="k">def</span> <span class="nf">log_in_factory</span><span class="p">(</span><span class="n">locator</span><span class="p">,</span> <span class="n">password_checker</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">log_in_user</span><span class="p">(</span><span class="n">login</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">locator</span><span class="p">(</span><span class="n">login</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">user</span> <span class="ow">and</span> <span class="n">password_checker</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">password</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
            <span class="n">login_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">AuthenticationError</span><span class="p">(</span><span class="s2">&quot;Bad login credentials&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">log_in_user</span>
</pre>
<p>This is a lot more testable, we only have to contend with one thing
outside of our control: <tt class="docutils literal">login_user</tt> rather than twelve things outside
our control. But then I thought about it some more. This is concerned
with authenticating a user. And there's a separate concern about
actually logging in the user. There's also a feature request on the
project about creating a JSON API, which will need to also authenticate
the user but probably not using password auth. Instead of using a
closure, what if I used the closest thing Python has to the
<tt class="docutils literal">interface</tt> keyword?</p>
<pre class="code ipython3 literal-block">
<span class="kn">from</span> <span class="nn">abc</span> <span class="k">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>

<span class="k">class</span> <span class="nc">Authenticator</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
    <span class="nd">&#64;abstractmethod</span>
    <span class="k">def</span> <span class="nf">authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">pass</span>
</pre>
<p>That's when the whole idea of software architecture really began falling
into place for me. Let's rejigger the current implementation to fit this
instead:</p>
<pre class="code ipython3 literal-block">
<span class="k">class</span> <span class="nc">PasswordAuthenticator</span><span class="p">(</span><span class="n">Authenticator</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">locator</span><span class="p">,</span> <span class="n">checker</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_locator</span> <span class="o">=</span> <span class="n">locator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_checker</span> <span class="o">=</span> <span class="n">checker</span>

    <span class="k">def</span> <span class="nf">authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">login</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_locator</span><span class="p">(</span><span class="n">login</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">user</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checker</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">password</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">user</span>
        <span class="k">raise</span> <span class="n">AuthenticationError</span><span class="p">(</span><span class="s2">&quot;Bad credentials&quot;</span><span class="p">)</span>
</pre>
<p>Instead of having the side effect -- actually logging in the user --
right there, the authenticator defines a contract that it either returns
a user or raises an AuthenticationError. We can also define an
implementation that will actually login the user as well:</p>
<pre class="code ipython3 literal-block">
<span class="k">class</span> <span class="nc">LoginAuthenticator</span><span class="p">(</span><span class="n">Authenticator</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">login</span><span class="p">,</span> <span class="n">authenticator</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_login</span> <span class="o">=</span> <span class="n">login</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_authenticator</span> <span class="o">=</span> <span class="n">authenticator</span>

    <span class="k">def</span> <span class="nf">authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_authenticator</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_login</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">user</span>
</pre>
<p>If we find that we're doing many things after authenticating a user
(updating a <tt class="docutils literal">last_seen</tt> field or keeping an audit log), we can further
generalize this to an <tt class="docutils literal">AfterAuthentication</tt> class that we simple give
the callable that causes the side effect.</p>
</div>
<div class="section" id="back-to-the-endpoint">
<h2>Back to the Endpoint</h2>
<p>Because of all this changing, we've broken every test on the controller
since it isn't equipped to deal with <em>any</em> of this. So we should revisit
it and make changes.</p>
<pre class="code ipython3 literal-block">
<span class="k">class</span> <span class="nc">LoginController</span><span class="p">(</span><span class="n">MethodView</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">authenticator</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_authenticator</span> <span class="o">=</span> <span class="n">authenticator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_form</span> <span class="o">=</span> <span class="n">LoginForm</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_form</span><span class="o">.</span><span class="n">validate_on_submit</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_authenticator</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">AuthenticationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">flash</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">'user.profile'</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
</pre>
<p>However, that post method is really concerned with a lot of stuff and is
indented quite a bit. There's two talks that influenced the next
changes. The first was <a class="reference external" href="https://www.youtube.com/watch?v=8bZh5LMaSmE">Sandi Metz's All the Little
Things</a>, where she
proposes a major tool in refactoring: the squint test.</p>
<blockquote>
You squit your eyes, and you lean back and you look at the code.
You're looking for changes in shape and changes in color.</blockquote>
<p>She goes on to say that changes in shape mean you have nested conditions
and that color changes means the code is at different levels of
abstraction. Which there definitely is here.</p>
<p>Discounting the class and method level indentations (because we have to
have those), the actual logic is indented two levels deep. Pretending we
have some Flask-specific code highlighting, we'd see that color bumped
against our code and the strings.</p>
<p>The first time around this, I ended up creating an <tt class="docutils literal">authenticate</tt>
method on the controller, following her advice to make smaller things.
The whole thing looked like this:</p>
<pre class="code ipython3 literal-block">
<span class="k">class</span> <span class="nc">LoginUser</span><span class="p">(</span><span class="n">MethodView</span><span class="p">):</span>
    <span class="n">decorators</span> <span class="o">=</span> <span class="p">[</span><span class="n">disallow_authenticated</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">authenticator</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_authenticator</span> <span class="o">=</span> <span class="n">authenticator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_form</span> <span class="o">=</span> <span class="n">LoginForm</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">validate_on_submit</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_authenticate</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_authenticator</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">AuthenticationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_handle_errors</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_redirect</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_handle_errors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">errors</span><span class="p">):</span>
        <span class="n">flash</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_redirect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">'user.profile'</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">username</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">'login.html'</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>
</pre>
<p>Which is slightly better, but the logic is still at different levels of
abstraction. And it's also not really a &quot;small class&quot;. It weighs in at
only 34 lines, which is actually quite small, but it has a very broad
surface area.</p>
<p>So I pondered some more and watched <a class="reference external" href="https://www.youtube.com/watch?v=CGN4RFkhH2M">Matt Wynne's Hexagonal
Rails</a>, I had a
different insight to Sandi's talk. Instead of trying to handle the
authentication and the error at the same level, why not provide an
interface on the controller that the authenticator can call into rather
than the controller asking for something to be done and acting on the
results.</p>
<pre class="code ipython3 literal-block">
<span class="k">class</span> <span class="nc">LoginUser</span><span class="p">(</span><span class="n">MethodView</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_form</span><span class="o">.</span><span class="n">validate_on_submit</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_authenticator</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">authentication_succeeded</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">'user.profile'</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">authentication_failed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error</span><span class="p">):</span>
        <span class="n">flash</span><span class="p">(</span><span class="n">error</span><span class="o">.</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_flash_errors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error</span><span class="p">):</span>
</pre>
<p>Which makes the controller act more high level. There's still some
differing levels of abstraction, but they only cross one level. It kicks
off some data through the authenticator interface and receives a message
back through its interface. We can place other things in the middle by
implementing either the Authenticator interface or this
interface...actually let's make this an interface itself:</p>
<pre class="code ipython3 literal-block">
<span class="k">class</span> <span class="nc">AuthenticationBoundary</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
    <span class="nd">&#64;abstractmethod</span>
    <span class="k">def</span> <span class="nf">authentication_succeeded</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="nd">&#64;abstractmethod</span>
    <span class="k">def</span> <span class="nf">authentication_failed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">pass</span>
</pre>
<p>But our authenticator has no way of talking back. And I think
implementing those details directly on an authenticator is a bad idea,
that gives it another reason to change. You might think of this as the
authenticator crossing multiple abstraction levels at once.</p>
<p>However, if we insert a bridge between them, it's easy to do. If you've
seen any variation on <a class="reference external" href="https://www.youtube.com/watch?v=WpkDN78P884">Uncle Bob's Architecture: The Lost Years
talk</a>, this is something
like his Interactor or Dr. Ivar Jacobson's Controller object:</p>
<pre class="code ipython3 literal-block">
<span class="k">class</span> <span class="nc">AuthenticateUser</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">authenticator</span><span class="p">,</span> <span class="n">listener</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_authenticator</span> <span class="o">=</span> <span class="n">authenticator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_listener</span> <span class="o">=</span> <span class="n">listener</span>

    <span class="k">def</span> <span class="nf">authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_authenticator</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">AuthenticationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_listener</span><span class="o">.</span><span class="n">authentication_failed</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_listener</span><span class="o">.</span><span class="n">authentication_succeeded</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre>
<p>This is pretty close to Sandi's idea. <a class="reference external" href="https://www.youtube.com/watch?v=o9pEzgHorH0">Jack Diederich might have some
negative things to say about
it</a>, but it's also
easily representable as a closure as well.</p>
<pre class="code ipython3 literal-block">
<span class="k">def</span> <span class="nf">authenticate_user</span><span class="p">(</span><span class="n">authenticator</span><span class="p">,</span> <span class="n">listener</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">authenticate</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">authenticate</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">AuthenticationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">listener</span><span class="o">.</span><span class="n">authenticate_failed</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">listener</span><span class="o">.</span><span class="n">authentication_succeeded</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">authenticate</span>
</pre>
<p>We could go one step in the opposite direction and have this implement
the <tt class="docutils literal">AuthenticationBoundary</tt>:</p>
<pre class="code ipython3 literal-block">
<span class="k">class</span> <span class="nc">AuthenticateUser</span><span class="p">(</span><span class="n">AuthenticationBoundary</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">authenticator</span><span class="p">,</span> <span class="n">listener</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_authenticator</span> <span class="o">=</span> <span class="n">authenticator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_listener</span> <span class="o">=</span> <span class="n">listener</span>

    <span class="k">def</span> <span class="nf">authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_authenticator</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">AuthenticationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">authentication_failed</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">authentication_succeeded</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">authentication_failed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">listener</span><span class="o">.</span><span class="n">authenticate_failed</span><span class="p">(</span><span class="n">errors</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">authentication_succeeded</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">listener</span><span class="o">.</span><span class="n">authentication_succeeded</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre>
<p>But I feel this is a bit cluttered and makes it more of a middle man
than an adapter.</p>
<p>You might be wondering why I pass the <tt class="docutils literal">*args</tt> and <tt class="docutils literal">**kwargs</tt> back up
through the listeners. And the reason is there might be information
contained in there, such as a &quot;remember me&quot; or &quot;stay logged in&quot; flag,
that doesn't apply to the authenticator itself, but could be interesting
to another listener.</p>
<p>Our <tt class="docutils literal">LoginAuthenticator</tt> can implement the Boundary interface rather
than the authenticator interface, since it's more a listener than an
authenticator -- it doesn't do any authentication, but responds to a
successful authentication. And since we pass the extra data back up, we
can pluck a remember flag out and pass it to <tt class="docutils literal">flask_login.login_user</tt>:</p>
<pre class="code ipython3 literal-block">
<span class="k">class</span> <span class="nc">LoginUser</span><span class="p">(</span><span class="n">AuthenticationBoundary</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">listener</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_listener</span> <span class="o">=</span> <span class="n">listener</span>

    <span class="k">def</span> <span class="nf">authentication_succeeded</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">login_user</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">remember</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'remember_me'</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_listener</span><span class="o">.</span><span class="n">authentication_succeeded</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">authentication_failed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_listener</span><span class="o">.</span><span class="n">authentication_failed</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
</pre>
<p>Finally, we need to make one last change in the controller. It has to
add itself to the authenticator, since we need to call back into it.</p>
<pre class="code ipython3 literal-block">
<span class="k">class</span> <span class="nc">LoginController</span><span class="p">(</span><span class="n">MethodView</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">authenticator</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_form</span> <span class="o">=</span> <span class="n">LoginForm</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_authenticator</span> <span class="o">=</span> <span class="n">authenticator</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</pre>
</div>
<div class="section" id="putting-the-pieces-together">
<h2>Putting the pieces together</h2>
<p>Gluing everything together is a little difficult, but it's manageable.</p>
<pre class="code ipython3 literal-block">
<span class="n">authenticator</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">listener</span><span class="p">:</span> <span class="n">AuthenticateUser</span><span class="p">(</span><span class="n">PasswordAuth</span><span class="p">(</span><span class="o">...</span><span class="p">),</span> <span class="n">Login</span><span class="p">(</span><span class="n">l</span><span class="p">))</span>

<span class="n">controller</span> <span class="o">=</span> <span class="n">LoginController</span><span class="p">(</span><span class="n">authenticator</span><span class="p">)</span>
</pre>
<p>By simply providing a little factory function, we don't even need to
wring our hands about <em>how</em> it gets in there. I've found this to be the
easiest, most efficient way to deal with this. There's other things we
can do, for example instead of hardcoding form, template and redirect
names, we can pass those in as well, allowing this controller to be
reused for other areas (I mentioned re-authenticating before).</p>
<pre class="code ipython3 literal-block">
<span class="k">class</span> <span class="nc">AuthenticationController</span><span class="p">(</span><span class="n">MethodView</span><span class="p">,</span> <span class="n">AuthenticationBoundary</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">,</span> <span class="n">authenticator</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">redirect</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_form</span> <span class="o">=</span> <span class="n">form</span><span class="p">()</span> <span class="c1"># concession to avoid the dreaded &quot;Working outside application context&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_authenticator</span> <span class="o">=</span> <span class="n">authenticator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_template</span> <span class="o">=</span> <span class="n">template</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_redirect</span> <span class="o">=</span> <span class="n">redirect</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_form</span><span class="o">.</span><span class="n">validate_on_submit</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_authenticator</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">authentication_succeeded</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_redirect</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">authentication_failed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error</span><span class="p">):</span>
        <span class="n">flash</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
</pre>
<p>A nice thing about this, by passing in a callable that returns a form,
we can instead pass a function that determines <em>which</em> form to use. For
example, you might have an option to enable ReCaptcha depending on some
application configuration and this form callable could look at that and
return the correct one. Or you need to allow the user to choose a
default language but the list of languages can only be decided at
runtime.</p>
<p>Note that since we're potentially reusing this, I've stripped out the
decorators line. <tt class="docutils literal">disallow_authenticated</tt> would be applied every time
we created a view from this and if we want to <em>re-authenticate</em> a user,
they're probably already authenticated. Instead, we'll need to apply it
by hand since it's now a situational decorator.</p>
<p>Uncle Bob does recommend one thing more: using a presenter that
transforms the response into a view model. In Python and Flask the view
model could be a dictionary or a object with arbitrary attributes (or
maybe a <tt class="docutils literal">dotteddict</tt>, I'm fond of those). However, I've decided
against that for two reasons:</p>
<ol class="arabic simple">
<li>It is another abstraction layer, which I don't feel is needed here.</li>
<li>I've not found an easy way to reconcile updating a form's errors
through this third party object.</li>
</ol>
<p>I suppose as one last thing, I should show how I've hooked this into an
actual Flask app.</p>
<pre class="code ipython3 literal-block">
<span class="kn">from</span> <span class="nn">flask</span> <span class="k">import</span> <span class="n">Blueprint</span>
<span class="kn">from</span> <span class="nn">.controllers</span> <span class="k">import</span> <span class="n">AuthenticateController</span>
<span class="kn">from</span> <span class="nn">.forms</span> <span class="k">import</span> <span class="n">LoginForm</span><span class="p">,</span> <span class="n">ReauthForm</span>
<span class="kn">from</span> <span class="nn">.listeners</span> <span class="k">import</span> <span class="n">LoginUser</span><span class="p">,</span> <span class="n">ReauthUser</span>
<span class="kn">from</span> <span class="nn">.interactors</span> <span class="k">import</span> <span class="n">AuthenticateUser</span>
<span class="kn">from</span> <span class="nn">..dependencies</span> <span class="k">import</span> <span class="n">password_auth</span> <span class="k">as</span> <span class="n">BasePasswordAuth</span>

<span class="n">authenticate</span> <span class="o">=</span> <span class="n">Blueprint</span><span class="p">(</span><span class="s1">'auth'</span><span class="p">,</span> <span class="vm">__name__</span><span class="p">)</span>

<span class="n">authenticate</span><span class="o">.</span><span class="n">add_url_rule</span><span class="p">(</span><span class="s1">'/login'</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="s1">'login'</span><span class="p">,</span>
    <span class="n">view_func</span><span class="o">=</span><span class="n">disallow_authenticated</span><span class="p">(</span>
            <span class="n">AuthenticateController</span><span class="o">.</span><span class="n">as_view</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s1">'login'</span><span class="p">,</span>
                <span class="n">template</span><span class="o">=</span><span class="s1">'auth/login.html'</span><span class="p">,</span>
                <span class="n">redirect</span><span class="o">=</span><span class="s1">'main.index'</span><span class="p">,</span>
                <span class="n">form</span><span class="o">=</span><span class="n">LoginForm</span><span class="p">,</span>
                <span class="n">authenticator</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="n">AuthenticateUser</span><span class="p">(</span><span class="n">BasePasswordAuth</span><span class="p">,</span> <span class="n">LoginUser</span><span class="p">(</span><span class="n">l</span><span class="p">))</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span>

<span class="n">authenticate</span><span class="o">.</span><span class="n">add_url_rule</span><span class="p">(</span><span class="s1">'/reauth'</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="s1">'reauth'</span><span class="p">,</span>
    <span class="n">view_func</span><span class="o">=</span><span class="n">AuthenticateController</span><span class="o">.</span><span class="n">as_view</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">'reauth'</span><span class="p">,</span>
            <span class="n">template</span><span class="o">=</span><span class="s1">'auth/reauth.html'</span><span class="p">,</span>
            <span class="n">redirect</span><span class="o">=</span><span class="s1">'main.index'</span><span class="p">,</span>
            <span class="n">form</span><span class="o">=</span><span class="n">ReauthForm</span><span class="p">,</span>
            <span class="n">authenticator</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="n">AuthenticateUser</span><span class="p">(</span><span class="n">BasePasswordAuth</span><span class="p">,</span> <span class="n">ReauthUser</span><span class="p">(</span><span class="n">l</span><span class="p">))</span>
        <span class="p">)</span>
    <span class="p">)</span>
</pre>
<p>Yes, it's <em>way</em> more lines of code, and certainly a fair number of
classes; however <a class="reference external" href="https://youtu.be/ajhqScWECMo?t=22m48s">Ross Tuck calls this &quot;The Inverse Biggie
Law&quot;</a>:</p>
<blockquote>
<p>Mo' classes</p>
<p>Mo' decoupling and reduced overall design issues</p>
</blockquote>
<p>Since we don't couple the high level policy -- see
<tt class="docutils literal">PasswordAuthenticator</tt> -- to the low level details of <em>how</em> we get
that information, each piece is independently testable. Want to see if
the controller behaves correctly? Give a fake form and a fake
authenticator. And since that's web aware logic, I'm okay with having to
run Flask to test it. You could also use <tt class="docutils literal">mock.patch.object</tt> and dummy
out the render and redirect methods on the controller to test if they're
called.</p>
<p>Or if you're testing if your AuthenticateUser use case calls back
correctly, give it a fake listener and a fake authenticator. Have the
fake authenticator throw an error in one test and return some fake user
in another -- does the fake listener get the right message?</p>
<p>But the important part is we can take <em>small</em> pieces and make a <em>big</em>
structure out of them. We can change how the big structure works by
handing it a different small piece.</p>
</div>
<div class="section" id="my-thoughts">
<h2>My Thoughts</h2>
<p>Is this <em>too</em> abstracted? Is enterprisey? It somewhat feels that way.
And logging in a user isn't the most compelling example, I'm more than
happy to concede that. But what if you were trying to implement
something more complicated? Say, users sending messages to each other.
How messy is that endpoint if we just jam everything in there? How hard
is that to test?</p>
<p>Of course, at some point this structure might begin to wobble and topple
just like the original one, but it will carry you <em>much</em> further. And
when it does begin to waver you might want to consider things like a
command bus or domain events (or both! they're really cool).</p>
<p>If you're interested in see how this is being implemented and used in a
real application and not just some toy, thought piece I'm leading the
rearchitecture of FlaskBB's code using this style. <a class="reference external" href="https://github.com/justanr/flaskbb/tree/services">Check out the
services branch on my
repo</a>.</p>
</div>

            <aside>
            <nav>
            <ul class="articles_timeline">
 
                <li class="previous_article">« <a href="http://justanr.github.io/simple-criteria-filtering-in-python" title="Previous: Simple Criteria Filtering in Python">Simple Criteria Filtering in Python</a></li>
 
                <li class="next_article"><a href="http://justanr.github.io/the-value-of-objects" title="Next: The Value of Objects">The Value of Objects</a> »</li>
            </ul>
            </nav>
            </aside>
<section>
<hr/>
<p id="comment-message">I spilled my brains, spill some of yours. </p>
<div class="accordion" id="accordion2">
    <div class="accordion-group">
        <div class="accordion-heading">
            <a class="accordion-toggle disqus-comment-count" data-toggle="collapse" data-parent="#accordion2" 
                href="http://justanr.github.io/exploring-code-architecture/#disqus_thread">
                Comments
            </a>
        </div>
        <div id="disqus_thread" class="accordion-body collapse">
            <div class="accordion-inner">
                <div class="comments">
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'ballinoctobear';
        var disqus_identifier = 'http://justanr.github.io/exploring-code-architecture';
    var disqus_url = 'http://justanr.github.io/exploring-code-architecture';

    (function() {
         var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
         dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
         (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
     })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>                </div>
            </div>
        </div>
    </div>
</div>
</section>
        </div>
        <section>
        <div class="span2" style="float:right;font-size:0.9em;">
 
            <h4>Published</h4>
            <time pubdate="pubdate" datetime="2015-10-27T00:00:00-04:00">Oct 27, 2015</time>
            <h4>Category</h4>
            <a class="category-link" href="/categories.html#design-ref">design</a> 
            <h4>Tags</h4>
            <ul class="list-of-tags tags-in-article"> 
                <li><a href="/tags.html#flask-ref">flask
                    <span>4</span>
</a></li>
                <li><a href="/tags.html#python-ref">python
                    <span>16</span>
</a></li>
            </ul>

        </div>
        </section>
    </div>
    </article>
                </div>
                <div class="span1"></div>
            </div>
        </div>
    </div>
<footer>
<div id="footer">
    <ul class="footer-content">
        <li class="elegant-license">Shared under the Creative Commons for content and MIT for code</li>
        <li class="elegant-power">Powered by <a href="http://getpelican.com/" title="Pelican Home Page">Pelican</a>. Theme: <a href="http://oncrashreboot.com/pelican-elegant" title="Theme Elegant Home Page">Elegant</a> by <a href="http://oncrashreboot.com" title="Talha Mansoor Home Page">Talha Mansoor</a></li>
    </ul>
</div>
</footer>            <script src="http://code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/js/bootstrap.min.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

<script type="text/javascript">
    var disqus_shortname = 'ballinoctobear';

    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
    </script>
    </body>
</html>