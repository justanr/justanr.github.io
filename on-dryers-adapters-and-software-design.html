<!DOCTYPE html>
<html lang="en-US">
    <head>
        <meta charset="utf-8"> 
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="author" content="Alec Nikolas Reiter" />
        <meta name="copyright" content="Alec Nikolas Reiter" />

        <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
        <link rel="stylesheet" href="/theme/slicknav.css">
        <script src="/theme/jquery.slicknav.min.js"></script>
        <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
        <script type="text/javascript"
            src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
        </script>
        <!--[if lt IE 9]>
        <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.6.2/html5shiv.js"></script>
        <![endif]-->


<meta name="keywords" content="python, design, tips and tricks, " />
        <title>On Dryers, Adapters and Software Design - from alec.thoughts import *
</title>
        <link href="http://cdn-images.mailchimp.com/embedcode/slim-081711.css" rel="stylesheet" type="text/css">
        <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/css/bootstrap-combined.min.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="http://justanr.github.io/theme/css/style.css" media="screen">
        <link rel="stylesheet" type="text/css" href="http://justanr.github.io/theme/css/solarizedlight.css" media="screen">
        <link rel="shortcut icon" href="http://justanr.github.io/theme/images/favicon.ico" type="image/x-icon" />
        <link rel="apple-touch-icon" href="http://justanr.github.io/theme/images/apple-touch-icon.png" />
        <link rel="apple-touch-icon" sizes="57x57" href="http://justanr.github.io/theme/images/apple-touch-icon-57x57.png" />
        <link rel="apple-touch-icon" sizes="72x72" href="http://justanr.github.io/theme/images/apple-touch-icon-72x72.png" />
        <link rel="apple-touch-icon" sizes="114x114" href="http://justanr.github.io/theme/images/apple-touch-icon-114x114.png" />
        <link rel="apple-touch-icon" sizes="144x144" href="http://justanr.github.io/theme/images/apple-touch-icon-144x144.png" />
        <link rel="icon" href="http://justanr.github.io/theme/images/apple-touch-icon-144x144.png" />
    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-64904436-1']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
    </head>
    <body>
        <div id="content-sans-footer">
        <div class="navbar navbar-static-top">
            <div class="navbar-inner">
                <div class="container">
                    <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </a>
                    <a class="brand" href="http://justanr.github.io/"><span class=site-name>from alec.thoughts import *</span></a>
                    <div class="nav-collapse collapse">
                        <ul class="nav pull-right top-menu">
                            <li ><a href="http://justanr.github.io">Home</a></li>
                            <li ><a href="http://justanr.github.io/categories.html">Categories</a></li>
                            <li ><a href="http://justanr.github.io/tags.html">Tags</a></li>
                            <li ><a href="http://justanr.github.io/archives.html">Archives</a></li>
                            <li><form class="navbar-search" action="http://justanr.github.io/search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="container-fluid">
            <div class="row-fluid">
                <div class="span1"></div>
                <div class="span10">
<article>
<div class="row-fluid">
    <header class="page_header span10 offset2">
    <h1><a href="http://justanr.github.io/on-dryers-adapters-and-software-design"> On Dryers, Adapters and Software Design  </a></h1>
    </header>
</div>

<div class="row-fluid">
        <div class="span8 offset2 article-content">

            <p>About two months ago we moved into our new apartment (with some help
from Kaitlyn's dad and my uncle). Loaded everything into the truck from
the old apartment, drove ten miles up the road to the new apartment and
then unloaded everything into the new apartment (on the third floor D:).</p>
<p>The first thing we moved up stairs was the washer. Plugged it in, hooked
it up, turned it on briefly to test. Boom, already feeling at home.
Actually, it was hot outside and this was an excuse to stand in the AC
for a minute. Then we decided, &quot;Well, we moved the washer, why not move
the dryer now?&quot; So we did. Got it up stairs (after almost dropping it
down a flight of stairs), pushed it into the laundry room and went to
plug it in and ... it's a different plug.</p>
<p>Apparently back in 2000, new residences were required to have four prong
outlets for dryers. And our dryer had a three prong plug. That's a
problem. My first thought was, &quot;We'll just get an adapter.&quot; Turns out,
that's a horrible idea and had I been thinking clearly, I wouldn't have
-- anyone who's used a grounded to ungrounded 120v adapter knows the
sorts of trouble that comes with that. We ended up replacing the actual
cable and plug -- the dryer had a little cover that pulled off and
exposed four connection screws: neutral, positive, negative and ground.
Just unscrew the old cable, screw on the new cable, plug it in and hope
I did it right otherwise a fire happens.</p>
<p>But there's an interesting thought: my first reaction was, &quot;Use an
adapter.&quot; I'll reach for a tool that takes some interface and maps it to
another interface. How often have I been faced with this <em>exact same
problem</em> in software and yet I've chosen to do something hard or
terrible instead? More often than I care to admit, honestly.</p>
<p>Let's look at an example. Something of a trivial example, but it
suffices for a blog post. Let's pretend that we've developed an app that
can send a user an authentication token for some purpose.</p>
<pre class="code ipython3 literal-block">
<span class="k">def</span> <span class="nf">send_user_auth_token</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">notifier</span><span class="p">):</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Your access code is </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">notifier</span><span class="o">.</span><span class="n">notify</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>
</pre>
<p>The actual business logic here doesn't even do anything (well, it
formats a string). It just delegates the work off to something else.</p>
<p>My bank uses a system like this for password resets, except I can choose
to get a text, an email or a phone call. They might even have a bit of
code that looks exactly like this.</p>
<p>Our imaginary app can do that as well. <em>How</em> though, that's the
question. We've provided no actual sending details here. There's no
&quot;Send text message&quot; or &quot;Send email&quot; or &quot;Initiate phone call&quot;. There's
also no &quot;fetch user&quot; or &quot;generate token&quot;. Instead, we're relying on the
fact that the notifier we pass it implements some <tt class="docutils literal">notify</tt> method that
will handle the actual notifying given the user and the token we
provide.</p>
<p>Let's implement a simple notifier that we can use as an inspiration, as
well as a user model and something to generate tokens.</p>
<pre class="code ipython3 literal-block">
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">namedtuple</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="k">import</span> <span class="n">SystemRandom</span>

<span class="n">User</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;User&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">,</span> <span class="s2">&quot;email&quot;</span><span class="p">,</span> <span class="s2">&quot;phone_number&quot;</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">generate_token</span><span class="p">(</span><span class="n">random_source</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">random_source</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">100000</span><span class="p">,</span> <span class="mi">999999</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">PrintingNotifier</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">notify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0.username}</span><span class="s2">: </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">message</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">True</span>

<span class="n">print_notifier</span> <span class="o">=</span> <span class="n">PrintingNotifier</span><span class="p">()</span>
<span class="n">justanr</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="s2">&quot;justanr&quot;</span><span class="p">,</span> <span class="s2">&quot;justanr&#64;service.com&quot;</span><span class="p">,</span> <span class="s2">&quot;9015555555&quot;</span><span class="p">)</span>
<span class="n">token</span> <span class="o">=</span> <span class="n">generate_token</span><span class="p">(</span><span class="n">SystemRandom</span><span class="p">())</span>

<span class="n">send_user_auth_token</span><span class="p">(</span><span class="n">justanr</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">print_notifier</span><span class="p">)</span>
</pre>
<pre class="literal-block">
justanr: Your access code is 614726
</pre>
<pre class="literal-block">
True
</pre>
<p>That's pretty cool. I bet we could replace that <tt class="docutils literal">PrintingNotifier</tt>
with something that sends a text message. Twilio's cool, let's use
that...but there's a problem. The code to send an SMS with Twilio looks
like this:</p>
<pre class="code ipython3 literal-block">
<span class="kn">from</span> <span class="nn">twilio.rest</span> <span class="k">import</span> <span class="n">TwilioRestClient</span>

<span class="n">client</span> <span class="o">=</span> <span class="n">TwilioRestClient</span><span class="p">(</span><span class="n">account_sid</span><span class="p">,</span> <span class="n">auth_token</span><span class="p">)</span>
<span class="n">message</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">messages</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="s1">'...'</span><span class="p">,</span> <span class="n">from_</span><span class="o">=</span><span class="s1">'...'</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="s1">'...'</span><span class="p">)</span>
</pre>
<p>We <em>can't</em> just drop that in...unless we modify the original function:</p>
<pre class="code ipython3 literal-block">
<span class="k">def</span> <span class="nf">polymorphic_notify_user</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">notifier</span><span class="p">):</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Your access code is </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">notifier</span><span class="p">,</span> <span class="n">PrintingNotifier</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">notifier</span><span class="o">.</span><span class="n">notifier</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">notifier</span><span class="p">,</span> <span class="n">TwilioRestClient</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">notifier</span><span class="o">.</span><span class="n">messages</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">phone_number</span><span class="p">,</span> <span class="n">from_</span><span class="o">=</span><span class="n">application_number</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>
</pre>
<p>If I had Twilio set up in this notebook, I could get a text messsage
that says, &quot;Your access code is 123456&quot;. But we've done something awful.
We've violated Single Responsibility. Our <tt class="docutils literal">send_user_auth_token</tt>
function has one responsibility: send some user some auth token using
some notifier. It <em>looks</em> like we've not violated, we've added a new
notifier so our function should be aware of it, right?</p>
<p>Nope. Are we going to add a new
<tt class="docutils literal">elif isinstance(notifier, SomeNotifierClass)</tt> every time we add one?
A check for Gmail, a check for SendMail, a check for this, a check for
that, a check for the TestNotifier! Each with code that knows <em>how to
send that particular notification.</em></p>
<p>What. Why does production code need to know about test code? We'll get
an issue that reads: &quot;NameError: TestNotifier not found&quot;. And it won't
be just once, it'll crop up again and again, everytime someone looks at
that file and sees <tt class="docutils literal">from ourapp.tests.fixtures import TestNotifier</tt>
and thinks, &quot;Wait..., why?&quot; and deletes it. Every time until finally,
fed up, you write a comment that says, &quot;DON'T REMOVE, NEEDED FOR
send_user_auth_token.&quot; You probably die a little bit inside, too. And
it won't be just this module and this function. It'll be every module
and every function.</p>
<p>I know because I've been there and I've done that and I handled it be
just not writing code for a long time.</p>
<p>No, no, no, let's back up to the original function.</p>
<pre class="code ipython3 literal-block">
<span class="k">def</span> <span class="nf">send_user_auth_token</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">notifier</span><span class="p">):</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Your access code is </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">notifier</span><span class="o">.</span><span class="n">notify</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>
</pre>
<p>This, I like this. It's simple. It's expressive. It does exactly what
the name says! In fact, I'd argue that it doesn't even need a docstring.
There's no if this type else that type. So, <em>how</em> can we use this
function to send a SMS with the TwilioRestClient that doesn't have an
interface that looks anything like this.</p>
<p>The same way we go from a grounded three prong plug to an ungrounded two
prong outlet (and the correct answer is <em>not</em> tear the ground pin out
despite what my power strips say), we use an adapter!</p>
<pre class="code ipython3 literal-block">
<span class="k">class</span> <span class="nc">TwilioSMSNotifier</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">twilio_client</span><span class="p">,</span> <span class="n">sender_number</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">twilio_client</span> <span class="o">=</span> <span class="n">twilio_client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sender_number</span> <span class="o">=</span> <span class="n">sender_number</span>

    <span class="k">def</span> <span class="nf">notify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="n">reciever</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">phone_number</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">twilio_client</span><span class="o">.</span><span class="n">messages</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">reciever</span><span class="p">,</span> <span class="n">from_</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sender_number</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">message</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">TwilioRestException</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
</pre>
<p>We could probably handle that failure case better. But that's not the
point here. We've taken an interface that's <em>completely different</em> and
changed it by wrapping it in a class that implements our interface. If
we wanted to send an email, we could simply create a new implementation:</p>
<pre class="code ipython3 literal-block">
<span class="k">class</span> <span class="nc">EmailNotifer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email_client</span><span class="p">,</span> <span class="n">to_html</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">email_client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">to_html</span> <span class="o">=</span> <span class="n">to_html</span>

    <span class="k">def</span> <span class="nf">notify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Two Factor Auth Code&quot;</span>
        <span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">encode_to_html</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_html</span> <span class="k">else</span> <span class="n">message</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">EmailClient</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sender</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sender</span> <span class="o">=</span> <span class="n">sender</span>

    <span class="k">def</span> <span class="nf">encode_to_html</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">'&lt;p&gt;</span><span class="si">{0}</span><span class="s1">&lt;/p&gt;'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">receiver</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">body</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">'title'</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span> <span class="s1">'receiver'</span><span class="p">:</span> <span class="n">receiver</span><span class="p">,</span> <span class="s1">'body'</span><span class="p">:</span> <span class="n">body</span><span class="p">}</span>


<span class="n">email_client</span> <span class="o">=</span> <span class="n">EmailClient</span><span class="p">(</span><span class="s1">'admin&#64;service.com'</span><span class="p">)</span>
<span class="n">email_notifier</span> <span class="o">=</span> <span class="n">EmailNotifer</span><span class="p">(</span><span class="n">email_client</span><span class="p">,</span> <span class="n">to_html</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">send_user_auth_token</span><span class="p">(</span><span class="n">justanr</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">email_notifier</span><span class="p">)</span>
</pre>
<pre class="literal-block">
{'body': '&lt;p&gt;Your access code is 614726&lt;/p&gt;',
 'receiver': <a class="reference external" href="mailto:'justanr&#64;service.com">'justanr&#64;service.com</a>',
 'title': 'Two Factor Auth Code'}
</pre>
<p>Here's an interesting thought: what if we don't know a head of time what
email provider will be used? Instead of writing a dozen different
<tt class="docutils literal">EmailProviderNotifier</tt> maybe we could conceive an <tt class="docutils literal">EmailClient</tt>
interface -- maybe it just exposes the <tt class="docutils literal">encode_to_html</tt> and <tt class="docutils literal">send</tt>
methods -- and then implement that with the provider we need and pass
<em>that</em> interface to <tt class="docutils literal">EmailNotifier</tt>? Our system becomes <em>more</em>
decoupled from what's steering it. We can provide <em>really</em> high level
policies internally and let something external from the application
provide implementations for them. We could simply tell end users,
&quot;Here's the <tt class="docutils literal">EmailClient</tt> interface, you need to implement that for
your provider and inject it into the application.&quot;</p>
<p>However, remember you can't abstract everything away. Eventually, you
need to write code that actually does something. But this
Interface-to-Interface pattern (also called a Bridge, but only when we
write both sides of it) has some <em>very interesting</em> ramifications for
our tests that I'll cover below.</p>
<p>What if we wanted to send the auth token as an email <em>and</em> a text
message. We can do that without hard coding <em>any</em> of them by reaching
for a different design pattern.</p>
<p>Related to the adapter pattern and the bridge pattern is the decorator
pattern. Rather than changing the interface to an object or connecting
two interfaces together, the decorator patterns adds additional
funtionality to an object by using the interface.</p>
<pre class="code ipython3 literal-block">
<span class="k">class</span> <span class="nc">MultiNotifier</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">notifiers</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">notifiers</span> <span class="o">=</span> <span class="n">notifiers</span>

    <span class="k">def</span> <span class="nf">notify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">notifier</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">notifiers</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">notifier</span><span class="o">.</span><span class="n">notify</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</pre>
<p>In this case, if we pass MultiNotifier to the <tt class="docutils literal">send_user_auth_token</tt>,
it's notify would be called which actually calls all of its internal
notifiers. If you wanted to do logging instead, you could pass a logger
and a notifier to the class and the notify method would log that a
message was sent and then use the internal notifier to do the actual
sending. Those two could even be combined:
<tt class="docutils literal">LoggingNotifier(my_logger, MultiNotifier(sms_notifier, email_notifier))</tt></p>
<p>Even better, with combinations like this, there's only one rule to
remember: plugs match outlets. The plugs in this case are our classes
and the outlets are the interfaces something expects to interact with.
More concretely, a plug would be the EmailClient and an Outlet is the
<tt class="docutils literal">send_user_auth_token</tt>. Since they don't match, we use an adapter.</p>
<p>And, a very happy side effect is that <tt class="docutils literal">send_user_auth_token</tt> is very
testable. It doesn't actually do anything, so there's nothing to mock
out. We just pass it exactly what we want it to use.</p>
<pre class="code ipython3 literal-block">
<span class="k">class</span> <span class="nc">TestEmailNotifier</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">notify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">'user_email'</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="s1">'body'</span><span class="p">:</span> <span class="n">message</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">test_send_auth_token_to_email</span><span class="p">():</span>
    <span class="n">token</span> <span class="o">=</span> <span class="mi">123456</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="s1">'justanr'</span><span class="p">,</span> <span class="s1">'justanr&#64;service.com'</span><span class="p">,</span> <span class="s1">'5555555555'</span><span class="p">)</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">send_user_auth_token</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">TestEmailNotifier</span><span class="p">())</span>
    <span class="k">assert</span> <span class="n">resp</span> <span class="o">==</span> <span class="p">{</span><span class="s1">'user_email'</span><span class="p">:</span> <span class="s1">'justanr&#64;service.com'</span><span class="p">,</span> <span class="s1">'body'</span><span class="p">:</span> <span class="s1">'Your access code is 123456'</span><span class="p">}</span>

<span class="n">test_send_auth_token_to_email</span><span class="p">()</span>
</pre>
<p>Imagine if we had hardcoded all the actual sending logic. What does the
test look like then?</p>
<pre class="code ipython3 literal-block">
<span class="kn">from</span> <span class="nn">unittest</span> <span class="k">import</span> <span class="n">mock</span>

<span class="nd">&#64;mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">'myapp.utils.send_user_email_token'</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="p">{</span><span class="o">...</span><span class="p">})</span>
<span class="nd">&#64;mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">'myapp.utils.find_user_by_id'</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="p">{</span><span class="o">...</span><span class="p">})</span>
<span class="nd">&#64;mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">'myapp.utils.generate_random_token'</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="mi">123456</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_send_user_auth_token</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">send_user_auth_token</span><span class="p">()</span> <span class="o">=</span> <span class="p">{</span><span class="o">...</span><span class="p">}</span>
</pre>
<p>We're patching three things and we probably still missed something.
Instead, with the decoupled version we can test that our business logic
-- given a user, a token and a notifier, send the user the token --
<em>works</em>.</p>
<p>We can also test if our adapters work, too.</p>
<pre class="code ipython3 literal-block">
<span class="k">def</span> <span class="nf">test_email_adapter_translates_correctly</span><span class="p">():</span>
    <span class="n">email_client</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">create_autospec</span><span class="p">(</span><span class="n">EmailClient</span><span class="p">)</span>
    <span class="n">notifier</span> <span class="o">=</span> <span class="n">EmailNotifer</span><span class="p">(</span><span class="n">email_client</span><span class="p">)</span>
    <span class="n">notifier</span><span class="o">.</span><span class="n">notify</span><span class="p">(</span><span class="n">User</span><span class="p">(</span><span class="s1">'justanr'</span><span class="p">,</span> <span class="s1">'alec&#64;service.com'</span><span class="p">,</span> <span class="s1">'5555555555'</span><span class="p">),</span> <span class="mi">123456</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">email_client</span><span class="o">.</span><span class="n">send</span><span class="o">.</span><span class="n">called</span> <span class="ow">and</span> \
        <span class="n">email_client</span><span class="o">.</span><span class="n">send</span><span class="o">.</span><span class="n">call_args</span> <span class="o">==</span> <span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s1">'alec&#64;service.com'</span><span class="p">,</span> <span class="s1">'Two Factor Auth Code'</span><span class="p">,</span> <span class="mi">123456</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_email_adapter_can_send_html_email</span><span class="p">():</span>
    <span class="n">email_client</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">create_autospec</span><span class="p">(</span><span class="n">EmailClient</span><span class="p">)</span>
    <span class="n">email_client</span><span class="o">.</span><span class="n">encode_to_html</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="s1">'&lt;p&gt;123456&lt;/p&gt;'</span>
    <span class="n">notifier</span> <span class="o">=</span> <span class="n">EmailNotifer</span><span class="p">(</span><span class="n">email_client</span><span class="p">,</span> <span class="n">to_html</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">notifier</span><span class="o">.</span><span class="n">notify</span><span class="p">(</span><span class="n">User</span><span class="p">(</span><span class="s1">'justanr'</span><span class="p">,</span> <span class="s1">'alec&#64;service.com'</span><span class="p">,</span> <span class="s1">'5555555555'</span><span class="p">),</span> <span class="mi">123456</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">email_client</span><span class="o">.</span><span class="n">send</span><span class="o">.</span><span class="n">called</span> <span class="ow">and</span> \
        <span class="n">email_client</span><span class="o">.</span><span class="n">send</span><span class="o">.</span><span class="n">call_args</span> <span class="o">==</span> <span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s1">'alec&#64;service.com'</span><span class="p">,</span> <span class="s1">'Two Factor Auth Code'</span><span class="p">,</span> <span class="s1">'&lt;p&gt;123456&lt;/p&gt;'</span><span class="p">)</span>

<span class="n">test_email_adapter_translates_correctly</span><span class="p">()</span>
<span class="n">test_email_adapter_can_send_html_email</span><span class="p">()</span>
</pre>
<p>Here's the interesting testing ramification I mentioned above. There's a
mantra in testing that says, &quot;Don't mock what you don't own.&quot; We don't
own the Gmail interface, we don't own the SendMail interface. <em>But</em> we
do own the <tt class="docutils literal">EmailClient</tt> interface so we can mock it. Here I do it
with Python 3.3's built in <tt class="docutils literal">unittest.mock.create_autospec</tt> but we
could also just write a stub that does the same thing.</p>
<p>When we're not terribly interested if Twilio is working or Gmail is
working, we can switch in another notifier. Just go, &quot;Oh, well...let's
use this one instead.&quot; We also don't dictate to users, &quot;You can only use
these email service providers.&quot; Instead we say, &quot;You can use any
provider you like <em>as long as you implement this interface.</em>&quot;</p>
<p>You change a few lines of code in a procedure that doesn't affect the
actual logic of <tt class="docutils literal">send_user_auth_token</tt>. Maybe it's a Flask end point?</p>
<pre class="code ipython3 literal-block">
<span class="kn">from</span> <span class="nn">flask</span> <span class="k">import</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">flash</span>
<span class="kn">from</span> <span class="nn">flask.views</span> <span class="k">import</span> <span class="n">MethodView</span>
<span class="kn">from</span> <span class="nn">myapp.logging</span> <span class="k">import</span> <span class="n">MasterLogger</span>
<span class="kn">from</span> <span class="nn">myapp.auth.forms</span> <span class="k">import</span> <span class="n">ChooseTokenNotifierForm</span>
<span class="kn">from</span> <span class="nn">myapp.notifiers</span> <span class="k">import</span> <span class="n">LoggingNotifier</span><span class="p">,</span> <span class="n">NotifierRepository</span>
<span class="kn">from</span> <span class="nn">myapp.models</span> <span class="k">import</span> <span class="n">User</span><span class="p">,</span> <span class="n">Token</span>

<span class="k">class</span> <span class="nc">SendUserAuthToken</span><span class="p">(</span><span class="n">MethodView</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_token_reset</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">form</span> <span class="o">=</span> <span class="n">ChooseTokenNotifierForm</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">force_token_reset</span> <span class="o">=</span> <span class="n">force_token_reset</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">process_notify_options</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">'auth/send_auth_token.html'</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">validate_on_form</span><span class="p">():</span>
            <span class="c1"># find the most appropriate notifier given the user's choice</span>
            <span class="n">notifier</span> <span class="o">=</span> <span class="n">NotifierRepository</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">notifiers</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="n">log_notifier</span> <span class="o">=</span> <span class="n">LoggingNotifer</span><span class="p">(</span><span class="n">MasterLogger</span><span class="p">,</span> <span class="n">notifier</span><span class="p">)</span>

            <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">active_token</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">active_token</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">active_token</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">force_token_reset</span><span class="p">:</span>
                <span class="n">active_token</span> <span class="o">=</span> <span class="n">Token</span><span class="o">.</span><span class="n">create_and_persist</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">generate_token</span><span class="p">(</span><span class="n">SystemRandom</span><span class="p">()))</span>

            <span class="n">did_token_send</span> <span class="o">=</span> <span class="n">send_user_auth_token</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">active_token</span><span class="o">.</span><span class="n">token</span><span class="p">,</span> <span class="n">log_notifier</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">did_token_send</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">'auth.verify_auth_token'</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">remove_notifier_option</span><span class="p">(</span><span class="n">notifier</span><span class="p">)</span>
                <span class="n">flash</span><span class="p">(</span><span class="s2">&quot;Are you sure that information is correct? Please contact customer service.&quot;</span><span class="p">,</span> <span class="s2">&quot;warning&quot;</span><span class="p">)</span>

        <span class="c1"># form didn't validate, so re-render and probably display errors</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">'auth/send_auth_token.html'</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>
</pre>
<p>And like that, almost by accident, we've stumbled upon something very
important: We've decoupled our business logic -- send the user the token
-- from the orchestration of <em>how we get that information</em>. Our token
sender doesn't care about:</p>
<ul class="simple">
<li>HTTP Endpoints</li>
<li>Form validation</li>
<li>Getting the correct user</li>
<li>The <em>actual sending</em> of the token</li>
<li>Creating a notifier</li>
<li>How to handle success and failure</li>
<li>ORM models</li>
<li>Other application endpoints</li>
<li><strong>*Everything that isn't using some object to send some token to some
user*</strong></li>
</ul>
<p>All of that stuff goes into our endpoint. We let some external thing
decide who the user is, what the token is, what notifier to use. How
complicated does this endpoint get if we don't use interfaces? How
convoluted, obscure and cryptic does the simple act of <em>sending a
message to the user</em> become? Probably very.</p>
<p>And by accidentally stumbling upon all of this, we've stumbled upon
something else even more important: application architecture. Something
I'm just now seriously beginning to apperciate and understand.</p>
<div class="section" id="thanks">
<h2>Thanks</h2>
<p>I didn't come up with. I'm not nearly that smart. Instead, this post has
been the product of <em>months of research</em> and playing with
implementations of it. It seemed so...over engineered at first. But
slowly, it's dawned on me that this is how to manage complexity in
applications. So I'd like to give thanks where it's due:</p>
<ul class="simple">
<li><a class="reference external" href="https://www.youtube.com/watch?v=DJtef410XaM">Brandon Rhodes' The Clean Architecture in
Python</a> -- This was
my first exposure to the idea. I thought, &quot;Oh that's an interesting
idea. Invert how I ususally think about abstracting my I/O.&quot; But I
didn't really apperciate what he saying at the time.</li>
<li><a class="reference external" href="https://www.youtube.com/watch?v=K5GguxPi3EA">Daniel Rocco's Clean and
Green</a> -- He gave the
original talk at PyATL back in January 2015, with less examples than
in the PyTenn talk. Here are the <a class="reference external" href="http://pyatl.github.io/talks/2015-01_patterns/clean_and_green.html">PyATL
slides</a>.
This is when the idea was planted. He recommended looking into Gary
Bernhardt and Uncle Bob's talks on the matter.</li>
<li>So I watched <a class="reference external" href="https://www.youtube.com/watch?v=yTkzNHF6rMs">Boundaries by Gary
Bernhardt</a>...which I
didn't let sink in because a) it's Ruby and I like Python, and b)
&quot;What the hell do tests have to do with design?&quot;. Pffft, pass.</li>
<li>I don't think I watched any of Uncle Bob's talks at this point, but I
ended up at <a class="reference external" href="https://vimeo.com/80533536">J.B. Rainsberger's Integrated Tests are a
Scam</a>, which after watching the talk
dozens of times, it began to make sense. I also realized what tests
have to do with design.</li>
<li>Eventually, I ended up watching some of Uncle Bob's videos (<a class="reference external" href="https://www.youtube.com/watch?v=WpkDN78P884">this one
for example</a>). And
after watching several variations on this talk dozens of times, this
began to make sense.</li>
<li>After the <em>idea</em> sank in, I began looking for examples of
applications that implement this architecture. I read a bunch of
articles that talked about the idea, but no implementations. Silly
me, I should've immediately gone to the
<a class="reference external" href="https://github.com/unclebob/fitnesse">FitNesse</a> repo and cloned
it and pored over it -- which I've now done, even if I don't
completely grok Java.</li>
<li>I also found a <a class="reference external" href="http://fideloper.com/hexagonal-architecture">very thorough
article</a> written with
a PHP mindset which gave not only explainations of the concepts but
<em>example code</em> for each concept -- and honestly, there is where I got
the notifier example from, I've merely adapted it to Python.</li>
<li>My dryer for being a completely unexpected source of inspiration for
software design.</li>
</ul>
</div>

            <aside>
            <nav>
            <ul class="articles_timeline">
 
                <li class="previous_article">« <a href="http://justanr.github.io/flask-lesser-knowns-pluggable-views" title="Previous: Flask Lesser Knowns: Pluggable Views">Flask Lesser Knowns: Pluggable Views</a></li>
 
                <li class="next_article"><a href="http://justanr.github.io/are-we-hiding-complexity-or-reducing-it" title="Next: Are we hiding complexity or reducing it?">Are we hiding complexity or reducing it?</a> »</li>
            </ul>
            </nav>
            </aside>
<section>
<hr/>
<p id="comment-message">I spilled my brains, spill some of yours. </p>
<div class="accordion" id="accordion2">
    <div class="accordion-group">
        <div class="accordion-heading">
            <a class="accordion-toggle disqus-comment-count" data-toggle="collapse" data-parent="#accordion2" 
                href="http://justanr.github.io/on-dryers-adapters-and-software-design/#disqus_thread">
                Comments
            </a>
        </div>
        <div id="disqus_thread" class="accordion-body collapse">
            <div class="accordion-inner">
                <div class="comments">
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'ballinoctobear';
        var disqus_identifier = 'http://justanr.github.io/on-dryers-adapters-and-software-design';
    var disqus_url = 'http://justanr.github.io/on-dryers-adapters-and-software-design';

    (function() {
         var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
         dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
         (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
     })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>                </div>
            </div>
        </div>
    </div>
</div>
</section>
        </div>
        <section>
        <div class="span2" style="float:right;font-size:0.9em;">
 
            <h4>Published</h4>
            <time pubdate="pubdate" datetime="2015-09-02T00:00:00-04:00">Sep 2, 2015</time>
            <h4>Category</h4>
            <a class="category-link" href="/categories.html#tips-and-tricks-ref">tips and tricks</a> 
            <h4>Tags</h4>
            <ul class="list-of-tags tags-in-article"> 
                <li><a href="/tags.html#design-ref">design
                    <span>7</span>
</a></li>
                <li><a href="/tags.html#python-ref">python
                    <span>18</span>
</a></li>
            </ul>

        </div>
        </section>
    </div>
    </article>
                </div>
                <div class="span1"></div>
            </div>
        </div>
    </div>
<footer>
<div id="footer">
    <ul class="footer-content">
        <li class="elegant-license">Shared under the Creative Commons for content and MIT for code</li>
        <li class="elegant-power">Powered by <a href="http://getpelican.com/" title="Pelican Home Page">Pelican</a>. Theme: <a href="http://oncrashreboot.com/pelican-elegant" title="Theme Elegant Home Page">Elegant</a> by <a href="http://oncrashreboot.com" title="Talha Mansoor Home Page">Talha Mansoor</a></li>
    </ul>
</div>
</footer>            <script src="http://code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/js/bootstrap.min.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

<script type="text/javascript">
    var disqus_shortname = 'ballinoctobear';

    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
    </script>
    </body>
</html>